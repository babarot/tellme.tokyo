
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="Kubernetes 上で Credentials を扱う - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2018/08/07/kubernetes-configmaps-secrets/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>Kubernetes 上で Credentials を扱う | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">Kubernetes 上で Credentials を扱う</h1>
    <h2 class="subtitle is-5">August 7, 2018 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/kubernetes">kubernetes</a>
    
        <a class="button is-link" href="/tags/kubernetes-configmaps">kubernetes-configmaps</a>
    
        <a class="button is-link" href="/tags/kubernetes-secrets">kubernetes-secrets</a>
    
</div>

    
    <br>
    <div class="content">
      <p>アプリケーションにロジックを外側から変更したい場合やソースコード外から設定されるべき情報 (API キーや何らかのトークン、その他の Credentials など) をアプリケーション側から読み取れるようにしたい場合がある。
よくある方法として、環境変数やフラグなどがある。</p>
<p>しかしこれらは往々にしてアプリケーションにハードコードされがちである (ロジックが書かれたファイル外に定義されたとしてもそれはハードコードに等しい)。
そうすると設定変更のたびにデプロイを必要とするし、言わずもがなセキュリティ的には厳しい。</p>
<p>またこの問題は、コンテナとマイクロサービスの領域において更に顕著になる。
同じデータを2つの異なるコンテナで参照する必要がある場合や、ホストマシンが使えないのでどうやってコンテナ内に渡すべきかを考える必要が出てくる。</p>
<p>実際にハードコードされたアプリケーションから環境変数に移し、それらをコンテナ化し Kubernetes に載せ替えてくステップを追う。</p>
<h2 id="アプリ側にハードコードされた例">アプリ側にハードコードされた例</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">language</span> <span class="o">=</span> <span class="s1">&#39;English&#39;</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">API_KEY</span> <span class="o">=</span> <span class="s1">&#39;123-456-789&#39;</span><span class="p">;</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`Language: </span><span class="si">${</span><span class="nx">language</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`API Key: </span><span class="si">${</span><span class="nx">API_KEY</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="sb">`\n`</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div><p>language やAPI キーを変更する場合は、コードを編集する必要がある。
またバグやセキュリティリーク、ソースコードの履歴を汚すアプローチである。</p>
<p>これの代わりに環境変数を使う。</p>
<h2 id="環境変数を使うパターン">環境変数を使うパターン</h2>
<h3 id="step-1-環境変数を読み込む">Step 1: 環境変数を読み込む</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LANGUAGE</span><span class="p">;</span>
  <span class="kr">const</span> <span class="nx">API_KEY</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_KEY</span><span class="p">;</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`Language: </span><span class="si">${</span><span class="nx">language</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`API Key: </span><span class="si">${</span><span class="nx">API_KEY</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
  <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="sb">`\n`</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div><p>環境変数を設定できるので、アプリケーションのコードに触れる必要はなくなる。</p>
<p>次のようにして現在のセッションの環境変数を設定できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">export</span> <span class="nv">LANGUAGE</span><span class="o">=</span><span class="s2">&#34;English&#34;</span>
<span class="nb">export</span> <span class="nv">API_KEY</span><span class="o">=</span><span class="s2">&#34;123-456-789&#34;</span>
</code></pre></div><h3 id="step-2-docker-の環境変数にする">Step 2: Docker の環境変数にする</h3>
<p>アプリケーションがコンテナ化されると、ホストの環境変数に依存しなくなる。
逆に言うとコンテナに閉じた環境内で正しく設定される必要がある。
これは Dockerfile の <code>ENV</code> ディレクティブで指定できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="k">FROM</span><span class="s"> node:6-onbuild</span><span class="err">
</span><span class="err"></span><span class="k">EXPOSE</span><span class="s"> 3000</span><span class="err">
</span><span class="err"></span><span class="k">ENV</span> LANGUAGE English<span class="err">
</span><span class="err"></span><span class="k">ENV</span> API_KEY 123-456-789<span class="err">
</span></code></pre></div><p>これを Dockerfile として保存してコードと同じディレクトリに置いてビルドする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ビルド</span>
docker build -t envtest .
<span class="c1"># 実行</span>
docker run -p 3000:3000 -ti envtest
</code></pre></div><h3 id="step-3-kubernetes-の環境変数にする">Step 3: Kubernetes の環境変数にする</h3>
<p>Docker コンテナを Kubernetes に移す。</p>
<p>Dockerfile と同様に、Kubernetes Deployment の YAML ファイルに直接環境変数を指定できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/&lt;PROJECT_ID&gt;/envtest</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">LANGUAGE</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;English&#34;</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">API_KEY</span><span class="w">
</span><span class="w">          </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;123-456-789&#34;</span><span class="w">
</span></code></pre></div><h3 id="step-4-kubernetes-secrets-と-configmaps">Step 4: Kubernetes Secrets と ConfigMaps</h3>
<p>Docker コンテナや Kubernetes での環境変数から設定を行う場合、コンテナや Deployment でのやり方に縛られてしまうという欠点がある。
環境変数を変更する場合は、コンテナを再ビルドするか、Deployment を変更する必要がでてくる。
また、この環境変数を他のコンテナや Deployment でも使用したい場合は、変数部分をコピペしていく必要がある。</p>
<p>しかし、Kubernetes は Secrets（機密データ用）と ConfigMaps（非機密データ用）という機能を持ってこれを解決している。</p>
<p>Secrets と ConfigMaps の大きな違いは、Secrets は Base64 エンコーディングで難読化されていること。
今後、Kubernetes のアップデートによって違いが出てくるかも知れないが、機密データ（API キーなど）は Secret に、非機密データ（ポート番号など）は ConfigMap という使い分けでいいと思う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># API_KEY を Secret に保存する</span>
kubectl create secret generic apikey --from-literal<span class="o">=</span><span class="nv">API_KEY</span><span class="o">=</span>123–456
<span class="c1"># LANGUAGE を ConfigMap に保存する</span>
kubectl create configmap language --from-literal<span class="o">=</span><span class="nv">LANGUAGE</span><span class="o">=</span>English
</code></pre></div><p>次のコマンドでこれらが作成されていることを確認できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">$ kubectl get secret
NAME                  TYPE                                  DATA      AGE
apikey                Opaque                                <span class="m">0</span>         45s
default-token-gfzcr   kubernetes.io/service-account-token   <span class="m">3</span>         11d

$ kubectl get configmap
NAME       DATA     AGE
language   <span class="m">1</span>        1m
</code></pre></div><p>こうすることで Deployment の YAML にハードコードする必要がなくなる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/&lt;PROJECT_ID&gt;/envtest</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span><span class="w">        </span><span class="nt">env</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">API_KEY</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">secretKeyRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">apikey</span><span class="w">
</span><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">API_KEY</span><span class="w">
</span><span class="w">        </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">LANGUAGE</span><span class="w">
</span><span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="nt">configMapKeyRef</span><span class="p">:</span><span class="w">
</span><span class="w">              </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">language</span><span class="w">
</span><span class="w">              </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l">LANGUAGE</span><span class="w">
</span></code></pre></div><h2 id="secrets-と-configmaps-の更新">Secrets と ConfigMaps の更新</h2>
<p>Secret や ConfigMap を使って Kubernetes に環境変数を管理させれば、変数の値を変更するときにコードを変更したりコンテナを再ビルドしたりする必要がなくなる。</p>
<p>環境変数の変更は、Secret または ConfigMap を更新したあとに、Pod を再起動することでできる (Pod は起動時に環境変数の値をキャッシュしているため)。</p>
<p>まず、値を更新する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl create configmap language --from-literal<span class="o">=</span><span class="nv">LANGUAGE</span><span class="o">=</span>Spanish -o yaml --dry-run <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> kubectl replace -f -
kubectl create secret generic apikey --from-literal<span class="o">=</span><span class="nv">API_KEY</span><span class="o">=</span><span class="m">098765</span> -o yaml --dry-run <span class="se">\
</span><span class="se"></span>    <span class="p">|</span> kubectl replace -f -
</code></pre></div><p>次に、Pod を再起動する。
これは、新しい Deployment を展開するなどがあるが、Pod を手動で削除することで Deployment に新しい Pod を自動で Rollout させるのが手っ取り早い。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">kubectl delete pod -l <span class="nv">name</span><span class="o">=</span>envtest
</code></pre></div><h2 id="設定をファイルから読む">設定をファイルから読む</h2>
<p>設定項目が多くない場合は環境変数は適しているが、アプリケーションに渡す必要のあるデータがたくさんあるときには向かない。
よくある解決策は、これらの設定を JSON/YAML/TOML などのファイルに落とし込み、そのファイルをアプリから読み込ませる手法などがある。</p>
<p>Kubernetes は ConfigMaps とSecrets をファイルとしてマウントさせることができる。
環境変数とは異なり、これらのファイルが変更されると、新しいファイルは再起動を必要とせずに実行中の Pod にプッシュされる。
また、複数の Config が置かれたディレクトリをマウントし、Secret/ConfigMap とすることもできる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash">mkdir config <span class="o">&amp;&amp;</span> mkdir secret
<span class="nb">echo</span> <span class="s1">&#39;{&#34;LANGUAGE&#34;:&#34;English&#34;}&#39;</span> &gt; ./config/config.json
<span class="nb">echo</span> <span class="s1">&#39;{&#34;API_KEY&#34;:&#34;123-456-789&#34;}&#39;</span> &gt; ./secret/secret.json
</code></pre></div><p>これに合わせて環境変数ではなくファイルから設定を読むようにアプリケーション側を変更しておく。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./config/config.json&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="kr">const</span> <span class="nx">language</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">config</span><span class="p">).</span><span class="nx">LANGUAGE</span><span class="p">;</span>
    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s1">&#39;./secret/secret.json&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">secret</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
      <span class="kr">const</span> <span class="nx">API_KEY</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">secret</span><span class="p">).</span><span class="nx">API_KEY</span><span class="p">;</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`Language: </span><span class="si">${</span><span class="nx">language</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="sb">`API Key: </span><span class="si">${</span><span class="nx">API_KEY</span><span class="si">}</span><span class="sb">\n`</span><span class="p">);</span>
      <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="sb">`\n`</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</code></pre></div><blockquote>
<p><em>注: このコードはすべてのリクエストに対してファイルを再読み込みする。プログラムの起動時に一度ファイルを読み込むようにするとファイルの更新は取得されず、ファイルを更新するためにコンテナを再起動する必要がでてくる</em></p>
</blockquote>
<h2 id="docker-volumes-を使ってファイルをマウントする">Docker volumes を使ってファイルをマウントする</h2>
<p>ローカルで簡単に試す方法として Docker ボリュームを使って ConfigMaps と Secrets をシミュレートできる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ビルド</span>
docker build -t envtest .
<span class="c1"># 実行</span>
docker run -p 3000:3000 -ti <span class="se">\
</span><span class="se"></span>  -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/secret/:/usr/src/app/secret/ <span class="se">\
</span><span class="se"></span>  -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>/config/:/usr/src/app/config/ <span class="se">\
</span><span class="se"></span>  envtest
</code></pre></div><blockquote>
<p><em>注: <a href="https://github.com/nodejs/docker-node/blob/master/6/onbuild/Dockerfile#4">onbuild コンテナ</a>は、コードを <code>/usr/src/app</code> ディレクトリに置くため、そこに対してマウントしている</em></p>
</blockquote>
<p><code>localhost:3000</code> にアクセスすると次にようになる。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*qqUtUpXoe9DRiMUtcrf0kw.png" alt=""></p>
<p>ファイルはコンテナにマウントされており、コードはリクエストごとにファイルを再読み込みするため、ファイルを変更して再起動せずに変更を確認できる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s1">&#39;{&#34;LANGUAGE&#34;:&#34;Spanish&#34;}&#39;</span> &gt; ./config/config.json
</code></pre></div><p><img src="https://cdn-images-1.medium.com/max/800/1*j_sIOIcnmgevdo7zI__XEA.png" alt=""></p>
<h2 id="ファイルから-secret-と-configmap-を作成する">ファイルから Secret と ConfigMap を作成する</h2>
<p>値から Secret/ConfigMap を作成したように、ファイルをデータソースとして作成することもできる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="c1"># ファイルから Secret を作成</span>
kubectl create secret generic my-secret --from-file<span class="o">=</span>./secret/secret.json
<span class="c1"># ファイルから ConfigMap を作成</span>
kubectl create configmap my-config --from-file<span class="o">=</span>./config/config.json
</code></pre></div><h2 id="secret-と-configmap-をファイルとして使う">Secret と ConfigMap をファイルとして使う</h2>
<p>最後に環境変数の代わりに Secret と ConfigMap をファイルとして使用する Deployment を作成する。</p>
<p>Deployment YAML では、Secret と ConfigMap をボリュームとして使用できる。
これにより、Docker の場合と同様に、コンテナ内のディレクトリにマウントされる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">extensions/v1beta1</span><span class="w">
</span><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">envtest</span><span class="w">
</span><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">gcr.io/smart-spark-93622/envtest:file5</span><span class="w">
</span><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">3000</span><span class="w">
</span><span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-config</span><span class="w">
</span><span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/src/app/config</span><span class="w">
</span><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-secret</span><span class="w">
</span><span class="w">            </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/usr/src/app/secret</span><span class="w">
</span><span class="w">      </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-config</span><span class="w">
</span><span class="w">        </span><span class="nt">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-config</span><span class="w">
</span><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">my-secret</span><span class="w">
</span><span class="w">        </span><span class="nt">secret</span><span class="p">:</span><span class="w">
</span><span class="w">          </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l">my-secret</span><span class="w">
</span></code></pre></div><h2 id="動的に更新">動的に更新</h2>
<p>ボリュームを使うことで動的に再マウントすることができる。
これは実行中のプロセスを再起動することなく、新しい Secret 値と ConfigMap 値がコンテナで使用可能になる。</p>
<p>たとえば、LANGUAGE を Klingon に変更し、ConfigMap を更新する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="nb">echo</span> <span class="s1">&#39;{&#34;LANGUAGE&#34;:&#34;Klingon&#34;}&#39;</span> &gt; ./config/config.json
kubectl create configmap my-config <span class="se">\
</span><span class="se"></span>  --from-file<span class="o">=</span>./config/config.json <span class="se">\
</span><span class="se"></span>  -o yaml --dry-run <span class="p">|</span> kubectl replace -f -
</code></pre></div><p>数秒（キャッシュに応じて最大1分）で新しいファイルが自動的に実行中のコンテナにプッシュされる。</p>
<p><img src="https://cdn-images-1.medium.com/max/800/1*wGebNWPZ_I_x0ruXA0ttrQ.gif" alt=""></p>
<h2 id="まとめ">まとめ</h2>
<ul>
<li>コンテナ化したアプリケーションへの設定注入は環境変数が良い</li>
<li>Dockerfile に書いてビルドするのではなく、Deployment 経由でプロセスに伝えるべき</li>
<li>Deployment YAML にハードコードするのではなく、Secret / ConfigMap 経由で伝えるべき</li>
<li>Secret / ConfigMap は Kubernetes の Key-value データストア (保存先は etcd) である</li>
<li>Secret / ConfigMap の違いは、
<ul>
<li>Secret: Base64 エンコードされるため、機密情報 (API ーなど) 向き</li>
<li>ConfigMap: 生データのまま保存されるため、それ以外の情報 (ポート番号など) 向き</li>
</ul>
</li>
<li>Secret / ConfigMap は値としてもファイルとしても作成できる</li>
</ul>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://medium.com/google-cloud/kubernetes-configmaps-and-secrets-68d061f7ab5b">https://medium.com/google-cloud/kubernetes-configmaps-and-secrets-68d061f7ab5b</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/</a></li>
<li><a href="https://vidhyachari.wordpress.com/2017/10/08/kubernetes-configmaps-and-secrets/">https://vidhyachari.wordpress.com/2017/10/08/kubernetes-configmaps-and-secrets/</a></li>
<li><a href="https://blog.giantswarm.io/understanding-basic-kubernetes-concepts-iv-secrets-and-configmaps/">https://blog.giantswarm.io/understanding-basic-kubernetes-concepts-iv-secrets-and-configmaps/</a></li>
<li><a href="https://medium.com/@xcoulon/managing-pod-configuration-using-configmaps-and-secrets-in-kubernetes-93a2de9449be">https://medium.com/@xcoulon/managing-pod-configuration-using-configmaps-and-secrets-in-kubernetes-93a2de9449be</a></li>
<li><a href="https://ubiteku.oinker.me/2017/03/01/kubernetes-secrets/">https://ubiteku.oinker.me/2017/03/01/kubernetes-secrets/</a></li>
<li><a href="https://cloud.google.com/kubernetes-engine/docs/concepts/secret">https://cloud.google.com/kubernetes-engine/docs/concepts/secret</a></li>
</ul>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2023 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



