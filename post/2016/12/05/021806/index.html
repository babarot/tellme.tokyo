
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="最近の Vim のプラグイン管理について考える - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2016/12/05/021806/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>最近の Vim のプラグイン管理について考える | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">最近の Vim のプラグイン管理について考える</h1>
    <h2 class="subtitle is-5">December 5, 2016 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/vim">vim</a>
    
</div>

    
    <br>
    <div class="content">
      
        <a href="https://b4b4r07.hatenadiary.com/entry/2016/12/05/021806">元記事</a><br><br>
      
      <p>この記事は <a href="http://qiita.com/advent-calendar/2016/vim">Vim Advent Calendar 2016</a> の 5 日目の記事です。</p>
<p>以前、neobundle.vim と vim-plug の比較記事を書きました((<a href="http://qiita.com/b4b4r07/items/fa9c8cceb321edea5da0">おい、NeoBundle もいいけど vim-plug 使えよ</a>))。それから数ヶ月後、dein.vim が登場し、再び比較記事を書こうと思っていたのですが、気づけばあれから 1 年が経っていました((dein.vim リリース前に Shougo さんから記事を書いてほしいといった DM を受け取っていた))。この記事は半年前 (&lsquo;16年8月頃) に大枠だけ書き Qiita の限定共有に投稿していたのものを Advent Calendar 向けに書き下ろしたものです((限定投稿していたのにも関わらず PV が多く、はてブが 12 付いていたので大部分を踏襲しつつ Shougo さんのインタビューを加えました))。</p>
<h2 id="vim-プラグインの歴史">Vim プラグインの歴史</h2>
<h3 id="github-以前-2008年">GitHub 以前 (〜2008年)</h3>
<p>昔の話です。Vim script で拡張の機能を書いたらそのスクリプトを <a href="http://www.vim.org">vim.org</a> にアップして開発者同士で共有したり、ユーザがダウンロードして使っていたようです。おそらくコレが所謂「プラグイン管理」の始まりなのですが、このときはまだ手動で行われていたようです (残念ながら、このときはまだ Vim に出会っていなかったためその肌感は分かりません&hellip;)。</p>
<p>例えば、こんな機能も Vim script で書いた拡張です (autogroup などは考慮してません)。</p>
<div class="highlight"><pre class="chroma"><code class="language-vim" data-lang="vim"><span class="nx">autocmd</span> <span class="nx">BufWritePre</span> * %<span class="nx">s</span><span class="sr">/\s\+$/</span>/<span class="nx">e</span><span class="err">
</span></code></pre></div><p>Vim 7 から Vimball という機能が Vim 本体に同梱されて、それからはこれを利用するユーザもいたようです。vim.org からアーカイブされたスクリプトを持ってきて、<code>:so %</code> したり、気に入ったら runtimepath 以下に置いて自動読み込みしたり。その頃の plugins ディレクトリは混沌としていたようです。ペライチのスクリプトが無造作に転がっており、同名ファイルに気をつけたりアップデートの情報は自分でキャッチしなければなりませんでした。</p>
<h3 id="github-以降-2008年">GitHub 以降 (2008年〜)</h3>
<p>GitHub は 2008 年頃発のサービスですが、翌年には最大の Git のホスティングサービスになっていたようです。本格的に流行りだしたのは 2011 年ころの印象を受けますが、このソーシャルコーディング時代の新風は Vim プラグイン界にも訪れ、席巻したようです。</p>
<p>Vim 界ではとりわけこのビッグウェーブに乗っかるのは早かったようで、Vim プラグインマネージャの代表的なものを時系列にしてみました (もちろんこれ以外にもたくさんの管理ツールがあります)。</p>
<p>※ 名称は現在 (2016-08-28) の時点でホスティングされている名前を取っています</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>Initial commit</th>
<th>特徴など</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/tpope/vim-pathogen">vim-pathogen</a></td>
<td>2008-10-23</td>
<td>bundle 以下を全部読み込む。ディレクトリごとに管理できるので革新的であった</td>
</tr>
<tr>
<td><a href="https://github.com/VundleVim/Vundle.vim">Vundle.vim</a></td>
<td>2010-10-17</td>
<td>Bundler の設計に影響を受けたらしく、設定ファイルを書くだけで GitHub からインストールすることができた</td>
</tr>
<tr>
<td><a href="https://github.com/Shougo/neobundle.vim">neobundle.vim</a></td>
<td>2011-09-17</td>
<td>Vundle の fork から始まった別物。出来ないことは少ない</td>
</tr>
<tr>
<td><a href="https://github.com/junegunn/vim-plug">vim-plug</a></td>
<td>2013-09-10</td>
<td>設計に優れている動作の速い NeoVim 互換のマネージャ</td>
</tr>
<tr>
<td><a href="https://github.com/Shougo/dein.vim">dein.vim</a></td>
<td>2015-12-13</td>
<td>neobundle.vim をリプレースするべく新設計のもとに作られた。NeoVim でも動作する</td>
</tr>
</tbody>
</table>
<p>GitHub 登場以降は <a href="http://www.vim.org">vim.org</a> にアップロードされるよりも、こっちで管理することも多くなってきていたようで、git-submodule で管理したり、vim-pathogen を利用して .vim ディレクトリ配下の見通しを良くしたり (ディレクトリごとに管理できた) いろいろ工夫しだしたころのようです。</p>
<p>そして、Vundle.vim によってリモートから直接インストール・アップデートすることができるようになり、モダン化しました。それ以降、大プラグインマネージャ時代が到来したようです。</p>
<p><strong>当時を伺える資料など</strong></p>
<ul>
<li><a href="http://vim-scripts.org/vim/tools.html">Vim Scripts</a></li>
<li><a href="http://www.vim.org/scripts/script.php?script_id=2332">pathogen.vim - Poor man&rsquo;s package manager. Easy manipulation of &lsquo;runtimepath&rsquo; et al : vim online</a></li>
<li><a href="http://tammersaleh.com/posts/the-modern-vim-config-with-pathogen/">Tammer Saleh : The Modern Vim Config with Pathogen</a></li>
<li><a href="http://vimcasts.org/episodes/synchronizing-plugins-with-git-submodules-and-pathogen/">Synchronizing plugins with git submodules and pathogen</a></li>
<li><a href="http://blog-en.shingara.fr/vundle-the-bundler-of-vim.html">vundle the bundler of vim - Shiny happy people coding</a></li>
</ul>
<h2 id="vim-plug-と-deinvim">vim-plug と dein.vim</h2>
<h3 id="特徴と知名度">特徴と知名度</h3>
<p>ここ最近 (直近 3 年間) の動向を見るとマストウォッチとなるのはこの 2 大プラグインマネージャでしょう。</p>
<table>
<thead>
<tr>
<th>機能</th>
<th>vim-plug</th>
<th>dein.vim</th>
</tr>
</thead>
<tbody>
<tr>
<td>高速インストール</td>
<td>○</td>
<td>○</td>
</tr>
<tr>
<td>遅延読み込み</td>
<td>○</td>
<td>○</td>
</tr>
<tr>
<td>キャッシュ</td>
<td>☓</td>
<td>○</td>
</tr>
<tr>
<td>シンプル</td>
<td>◎</td>
<td>○</td>
</tr>
<tr>
<td>高機能</td>
<td>○</td>
<td>◎</td>
</tr>
<tr>
<td>外部ファイル</td>
<td>☓</td>
<td>○ (TOML)</td>
</tr>
</tbody>
</table>
<p>ここで、2 大プラグインマネージャに加えて、日本において絶大な知名度のある neobundle.vim (検索ワードには <code>NeoBundle</code> を使用しました) を加えてトレンドを見てみました。</p>
<p>※ 赤:NeoBundle、黄:vim-plug、青:dein.vim</p>
<!-- raw HTML omitted -->
<p><a href="https://www.google.co.jp/trends/explore?geo=JP&amp;q=dein.vim,NeoBundle,vim-plug">https://www.google.co.jp/trends/explore?geo=JP&amp;q=dein.vim,NeoBundle,vim-plug</a></p>
<p>結果としては NeoBundle がまだまだ元気なようです (ただ、これは検索トレンドなので、移行情報などを調べているのかもしれませんし、内容まではわかりません)。しかし、登場から半年で dein.vim は neobundle.vim のリプレースと vim-plug に対抗して、急成長中であることがわかります。</p>
<h3 id="比較">比較</h3>
<h4 id="設定ファイル">設定ファイル</h4>
<p>dein.vim に関する設定方法は Web に先行記事が出回っているのでそれを参照しましょう。しかし、基本的に絶賛開発中のプラグインの場合 Web 記事はすぐに使い物にならなくなったりするので (この記事も例外ではありません)、リポジトリの README.md か <a href="https://github.com/Shougo/dein.vim/blob/master/doc/dein.txt"><code>:h dein.vim</code></a> でどんな機能があるのか見るのが一番です。</p>
<p>Minimal vimrc を見て比較してみます。</p>
<!-- raw HTML omitted -->
<p>call dein#begin('/home/b4b4r07/.dein&rsquo;)
call dein#add(&lsquo;b4b4r07/vim-shellutils&rsquo;)
call dein#end()</p>
<p>filetype plugin indent on
<!-- raw HTML omitted --><!-- raw HTML omitted --><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>vim-plug のほうが短くなっています。このカラクリについて、dein.vim 1 行目は vim-plug は <code>.vim/autoload</code> 配下にインストールすることを推奨されているから不要となっています (シングルファイルの利点です)。dein.vim 5 行目については vim-plug では <code>plug#end()</code> に含まれているため不要となっています。これらの処理がプラグインマネージャ側でハンドリングされるのはメリットデメリット両方ありそうです。</p>
<p>実際には dein.vim にはもう少し設定が必要です。dein.vim の README.md か bin/installer.sh で吐き出されるミニマル vimrc を参考にしましょう。</p>
<h4 id="読み込み速度">読み込み速度</h4>
<p>計測したときの条件は以下です。</p>
<ul>
<li>Vim 7.4</li>
<li>素の Vim</li>
<li>プラグインは 46 個
<ul>
<li>どちらも同じプラグインを使用</li>
<li>どちらも最大限に遅延読み込みを利用</li>
</ul>
</li>
<li>100 回計測する (<a href="https://gist.github.com/b4b4r07/3eccb4f8dd9438c706fe7950ef2f669f">使ったスクリプト</a>)</li>
<li>dein.vim はキャッシュを使わない (後付条件です)</li>
</ul>
<pre><code class="language-console" data-lang="console">$ vim --startup-time=time.log +q
</code></pre><p><strong>結果:</strong></p>
<table>
<thead>
<tr>
<th>速度</th>
<th>vim-plug</th>
<th>dein.vim</th>
</tr>
</thead>
<tbody>
<tr>
<td>最大</td>
<td>064.258</td>
<td>048.796</td>
</tr>
<tr>
<td>最小</td>
<td>051.208</td>
<td>040.023</td>
</tr>
<tr>
<td>平均</td>
<td>056.659</td>
<td>043.699</td>
</tr>
</tbody>
</table>
<p>結果としては dein.vim のほうが速いようです。dein.vim の最大時間より vim-plug の最小時間のほうが大きいことからみても相当早いと言えそうです。なお、キャッシュを使用していないので、キャッシュ込みだとひとまず太刀打ちできないと言えそうです（あくまでそれぞれの環境に依存します）。</p>
<p>しかしながら、どちらも十分に速いです。おそらく人間のエンジニアやプログラマが通常用途でエディタを使う分にはもう誤差であると言えそうです。</p>
<p>ローカルでのファイル編集における応答時間の話で、以下の記事を持ち出すのはイケてないかもしれませんが参考として載せておきます。1993 年に書かれた応答時間における 3 つの限界の話です。</p>
<ul>
<li><a href="https://u-site.jp/alertbox/20100621_response-times">Webサイトの応答時間 – U-Site</a></li>
<li><a href="https://www.nngroup.com/articles/response-times-3-important-limits/">Response Time Limits: Article by Jakob Nielsen</a></li>
</ul>
<p>0.1 秒、つまり 100 ミリ秒 (ms) 以下を争ってもユーザの体感できる領域ではないです。これ以上に関して、ソフトウェアはどうするべきかについては述べられないので、応答時間と人間工学に関する論文なりを読みましょう。</p>
<h3 id="deinvim">dein.vim</h3>
<p>作者の <a href="https://twitter.com/ShougoMatsu">@Shougo</a> さんにお話を聞く機会があったため (2015年12月ころ〜)、dein.vim の設計思想は背景部分などについて聞いてみました。</p>
<ul>
<li>リリース
<ul>
<li>2016/1/1 - <a href="https://github.com/Shougo/dein.vim/tree/00a163e5eeffa0f2bae8befba9135108120e5c83">Shougo/dein.vim at 00a163e</a></li>
</ul>
</li>
<li>初期設計についてのお話 (一般的な)
<ul>
<li>ユーザが少ないうちは後方互換性など気にせずガンガン変更しても問題なかったり</li>
<li>ユーザが付いてしまうとそれは大変なので、最初のうちにできるだけ汎用的で優れた作りにしておきたい</li>
<li>ちまちま neobundle.vim を改修することも思案したが、内部実装がグチャグチャしてきているのでメンテナンスが大変で、新規機能追加どころではなかった</li>
</ul>
</li>
<li>高速で記述量が少なく、メンテしやすく、簡単にテストができる
<ul>
<li>コマンドを全て廃止し、関数のみにし、プラグインの設定は TOML で行う → シンプルな設計
<ul>
<li>プラグインのインストールは unite インタフェースで行うという割り切り (これが Shougo さんの考えるシンプルさ)</li>
<li>Vim script で UI を作りたくないという思惑もある</li>
</ul>
</li>
<li>neobundle.vim は Vundle からの移行と互換性を目標にしていたので、古い仕様を引きずりすぎていた</li>
</ul>
</li>
<li>Vim と NeoVim どっちに対応するか
<ul>
<li>結果としては両方 (Vim 8.0 以上と NeoVim)</li>
<li>NeoVim 専用にすると Vim と使い分けるのが面倒だった</li>
<li>NeoVim 専用にするとリモートプラグイン((リモートプラグインとは、deoplete で使われている技術です。非同期でリモートプラグイン側を動かして MessageRPC で通信します。NeoVim JOB API はプラグインの一部を非同期で動かしますが、リモートプラグインだとスレッドなしで全体を非同期で動かせます))の起動の遅さが目立った</li>
</ul>
</li>
<li>起動速度の最適化
<ul>
<li>neobundle.vim はキャッシュを使えば vim-plug と同等以上であった</li>
<li>neobundle.vim のボトルネックはコマンドのパースと、余計なファイル読み込み</li>
<li>しかし、適切に読み込むファイルを分割すれば高速化が期待できるので要研究</li>
</ul>
</li>
<li>知名度について
<ul>
<li>特に PR はしていないのに neobundle.vim が一般的になれた発端は Lingr だと推測</li>
<li>よく発言することの多いのは vim-jp のメンバーであったりコアな Vim ユーザであるが意外と Read Only な利用者も多いとのこと</li>
</ul>
</li>
<li>ベンチマーク (Shougo さんの環境での)
<ul>
<li>123 個のプラグイン、キャッシュありで 79 ミリ秒ほど。環境は NeoVim (2016/02/14 時点)
<ul>
<li>(補足) 後日談で更に高速化したとのこと</li>
</ul>
</li>
</ul>
</li>
<li>高速化について
<ul>
<li>これまでのキャッシュはパース結果をキャッシュするだけだった</li>
<li>dein.vim では内部状態を保存するようにして、それを読み込んだときの時間を最小化した</li>
<li>Vim script 実装でキャッシュという仕組みを使うプラグインでは最速の部類</li>
<li>残るボトルネックは変数の代入だが、これは最適化不能なのでここで打ち止め</li>
<li>Vim script でない実装だと、<a href="https://github.com/itchyny/miv">miv</a> や <a href="https://github.com/kamichidu/vim-hariti">vim-hariti</a> あたりが速度的に好敵手</li>
</ul>
</li>
</ul>
<p>参考: <a href="https://herringtondarkholme.github.io/2016/02/26/dein/">https://herringtondarkholme.github.io/2016/02/26/dein/</a></p>
<h3 id="標準パッケージ管理">標準パッケージ管理</h3>
<p>Vim 8.0 (7.4.1480~) からは標準のプラグイン管理機構が追加されました。<code>:help packages</code> で見れます。</p>
<h2 id="まとめ">まとめ</h2>
<p>結論はお好きなプラグインマネージャを使いましょう、です。どちらも盛んに開発されています。自分のスタイルやマインドに合致したものを使えばいいと思います。もちろん vim-plug や dein.vim 以外にもたくさんのプラグインマネージャがあります。これを機にいろいろ探してみてもいいかもしれません。</p>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
    
      <a href="http://b.hatena.ne.jp/entry/https://b4b4r07.hatenadiary.com/entry/2016/12/05/021806" class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2020 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



