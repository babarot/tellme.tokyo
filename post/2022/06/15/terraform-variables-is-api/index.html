
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="Terraform の Variables と Locals、Outputs - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2022/06/15/terraform-variables-is-api/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>Terraform の Variables と Locals、Outputs | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">Terraform の Variables と Locals、Outputs</h1>
    <h2 class="subtitle is-5">June 15, 2022 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/terraform">terraform</a>
    
</div>

    
    <br>
    <div class="content">
      <h2 id="それぞれの役割">それぞれの役割</h2>
<p>Terraform で &ldquo;変数&rdquo; というと、<a href="https://www.terraform.io/language/values/variables">Variables</a> と <a href="https://www.terraform.io/language/values/locals">Locals</a> がある。どちらも値を入れて、Terraform ファイル や <a href="https://www.terraform.io/language/modules/syntax">Terraform Module</a> から参照することができる。ちなみに Terraform Module とは「<code>.tf</code> ファイルが置かれたディレクトリ」を意味する。main.tf などを置いた瞬間からそのディレクトリは Module として扱われ、起点となる Module を Root Module と呼ぶ。</p>
<p>Terraform では &ldquo;変数&rdquo; 以外に &ldquo;返り値&rdquo; (Return value) に相当するものとして <a href="https://www.terraform.io/language/values/outputs">Outputs</a> がある。これは Module での処理結果を Module 外から参照できるようにするために使うものである。</p>
<p>それぞれについて公式ドキュメントでは次のように紹介されている。</p>
<ul>
<li>Input Variables serve as parameters for a Terraform module, so users can customize behavior without editing the source.</li>
<li>Output Values are like return values for a Terraform module.</li>
<li>Local Values are a convenience feature for assigning a short name to an expression.</li>
</ul>
<p><a href="https://www.terraform.io/language/values">Variables and Outputs | Terraform by HashiCorp</a></p>
<p>要約すると次のように考えられる。もちろん、ここで指している &ldquo;Terraform module&rdquo; とは Root Module (main.tf を置いただけのディレクトリ) についても含んでいる。</p>
<ul>
<li>Variables は Terraform module のパラメータであり、tf ファイルを変更することなく module の挙動を変えることができるもの</li>
<li>Outputs は Terraform module の返り値</li>
<li>Locals は式に別名を付けるための便利なもの</li>
</ul>
<p>それぞれの役割をプログラミング言語に例えるとイメージしやすいかもしれない。</p>
<p><img src="signature.png" alt=""></p>
<p>そうすると、関数の中身を Module と捉えることができ、Locals はローカル変数であるといえる。</p>
<h2 id="variables-と-outputs-は-api">Variables と Outputs は API</h2>
<p>Variables は「ユーザが Module のコードを変更することなく Module の挙動を変えるためのパラメータ」であるとわかった。</p>
<p>次のような variable の定義があったとする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">variable</span> <span class="s2">&#34;enable_xxx_feature&#34;</span> {
<span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;Enable XXX&#34;</span>

<span class="n">  type</span>    <span class="o">=</span> <span class="k">bool</span>
<span class="n">  default</span> <span class="o">=</span> <span class="kt">false</span>
}
</code></pre></div><p>このとき、Module 側の resource 定義で <code>var.enable_xxx_feature</code> の値を見て <a href="https://tellme.tokyo/post/2022/06/12/terraform-count-for-each/">true/false によって作成の有無を判断する</a> (&ldquo;count を使うとき&rdquo; 参照) ようになっていた場合、コードを変更することなく外部から Module の挙動を変えることができる。</p>
<p>上のような Bool のフラグ以外にも、</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">variable</span> <span class="s2">&#34;service_name&#34;</span> {
<span class="n">  type</span> <span class="o">=</span> <span class="k">string</span>
}
</code></pre></div><p>このような variable についても、外部から <code>service_name</code> を与えその値によって作られるリソース名が変わることを考えると「コードを変更することなく外部から Module で作られるリソースの名前を変えるためのパラメータ」であるといえる。</p>
<p>ちなみに <a href="https://www.terraform.io/language/values/variables#default-values">default</a> を設定しない場合、terraform コマンドの実行時にプロンプト経由で必ず聞かれる (引数で渡した場合はその値が使用される)。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan -var<span class="o">=</span><span class="s2">&#34;service_name=myservice&#34;</span>
<span class="err">
</span><span class="err"></span><span class="go">No changes. Your infrastructure matches the configuration.
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Terraform has compared your real infrastructure against your configuration and found no differences, so no changes are needed.
</span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan
<span class="go">var.service_name
</span><span class="go">  Enter a value: _
</span></code></pre></div><p>また、Variables では <a href="https://www.terraform.io/language/values/variables#custom-validation-rules">validation</a> を設定することができる。これは「ユーザからの入力を期待する」Variable ならではの Argument である。ちなみにユーザによって値をオーバーライドされない Locals にはこの機能はない。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">variable</span> <span class="s2">&#34;gcp_project_id&#34;</span> {
<span class="n">  type</span> <span class="o">=</span> <span class="k">string</span>

  <span class="k">validation</span> {
<span class="n">    condition</span>     <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">var</span><span class="p">.</span><span class="k">gcp_project_id</span><span class="p">)</span> <span class="err">&lt;</span> <span class="m">30</span>
<span class="n">    error_message</span> <span class="o">=</span> <span class="s2">&#34;Length of GCP project ID should be less than 30 (GCP limitation).&#34;</span>
  }
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan
<span class="go">var.gcp_project_id
</span><span class="go">  Enter a value: too-long-long-long-long-project-id
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">╷
</span><span class="go">│ Error: Invalid value for variable
</span><span class="go">│
</span><span class="go">│   on variable.tf line 1:
</span><span class="go">│    1: variable &#34;gcp_project_id&#34; {
</span><span class="go">│     ├────────────────
</span><span class="go">│     │ var.gcp_project_id is &#34;too-long-long-long-long-project-id&#34;
</span><span class="go">│
</span><span class="go">│ Length of GCP project ID should be less than 30 (GCP limitation).
</span><span class="go">│
</span><span class="go">│ This was checked by the validation rule at variable.tf:4,3-13.
</span><span class="go">╵
</span></code></pre></div><p>このように Variables はユーザに一番近いレイヤであり、インターフェイスである。常に値をオーバーライドされる可能性がある。</p>
<p>同様に Outputs にも同じことがいえる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">output</span> <span class="s2">&#34;id&#34;</span> {
<span class="n">  value</span> <span class="o">=</span> <span class="k">format</span><span class="p">(</span><span class="s2">&#34;myservice-%s-prod&#34;</span><span class="p">,</span> <span class="k">var</span><span class="p">.</span><span class="k">gcp_project_id</span><span class="p">)</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan
<span class="go">var.gcp_project_id
</span><span class="go">  Enter a value: babarot-pricing
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">Changes to Outputs:
</span><span class="go">  + id = &#34;myservice-babarot-pricing-prod&#34;
</span><span class="go"></span><span class="err">
</span><span class="err"></span><span class="go">You can apply this plan to save these new output values to the Terraform state, without changing any real infrastructure.
</span></code></pre></div><p>Variables と Outputs はユーザに公開されたインターフェイスであり、API と同様の性質を持つ。一度公開すると簡単には変更できず削除できない。どのような Input として Variables を定義し、どのような Output をすべきかを考えて Outputs を定義する必要がある。</p>
<p><img src="api.png" alt=""></p>
<h2 id="どのような-api-を定義するべきか">どのような API を定義するべきか</h2>
<p>Module を定義して外部に公開する場合 (ここでいう外部とは Module 管理者以外を指し必ずしもインターネットで公開することを意味しない) 常にどんな Variables を定義するかを考える必要がある。Outputs についても同様で、一度公開しひとたび参照されてしまうと、うかつに削除することができなくなる。</p>
<p>例えば「サービスの立ち上げに必要なツールセットを作成する」Module (service-kit とする) があったとする。</p>
<p>サービスの立ち上げ時に必要なもの:</p>
<ul>
<li>GCP プロジェクト</li>
<li>GitHub Team</li>
<li>PagerDuty (Service / Team / Escalation Policy / Schedule)</li>
<li>Datadog (Monitor / Alert)</li>
<li>Slack (mention group / channel)</li>
<li>&hellip;</li>
</ul>
<p>それぞれの機能を有効にするかどうかを variable <code>enable_xxx</code> として定義することが考えられる。サービスによっては PagerDuty による OnCall 設定を必要としたり、しなかったりが想定できるからである。また、PagerDuty の基本的な設定はするが <a href="https://support.pagerduty.com/docs/schedule-examples">Schedule</a> (OnCall Shift) の機能だけ使わないケースがあるとする。その場合もそれだけを無効にしたりと外部から変更できるようになっていると嬉しい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># モジュール側
</span><span class="c1"></span><span class="k">variable</span> <span class="s2">&#34;pagerduty&#34;</span> {
<span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;PagerDuty configurations&#34;</span>

<span class="n">  type</span> <span class="o">=</span> <span class="k">object</span><span class="p">(</span>{
<span class="n">    enable</span>          <span class="o">=</span> <span class="k">bool</span>
<span class="n">    create_schedule</span> <span class="o">=</span> <span class="k">bool</span>
  }<span class="p">)</span>
<span class="n">  default</span> <span class="o">=</span> {
<span class="n">    enable</span>          <span class="o">=</span> <span class="kt">false</span>
<span class="n">    create_schedule</span> <span class="o">=</span> <span class="kt">false</span>
  }
}
</code></pre></div><p>こうすることで、ユーザのユースケースに応じて Module の振る舞いを変更できる余地を与える。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># ユーザ側
</span><span class="c1"></span><span class="k">module</span> <span class="s2">&#34;myservice&#34;</span> {
<span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;git://...&#34;</span><span class="c1">
</span><span class="c1">
</span><span class="c1">  # PagerDuty の機能は使うが、Schedule (OnCall Shift) だけは作らない
</span><span class="c1"></span><span class="n">  pagerduty</span> <span class="o">=</span> {
<span class="n">    enable</span>          <span class="o">=</span> <span class="kt">true</span>
<span class="n">    create_schedule</span> <span class="o">=</span> <span class="kt">false</span>
  }
}
</code></pre></div><p>一方で良くない Variables の定義は何かを考えてみる。</p>
<p>例えば次のような variable を定義したとする。GCP プロジェクトを作成したときに紐付ける Billing account の設定である。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># モジュール側
</span><span class="c1"></span><span class="k">variable</span> <span class="s2">&#34;billing_account&#34;</span> {
<span class="n">  type</span>    <span class="o">=</span> <span class="k">string</span>
<span class="n">  default</span> <span class="o">=</span> <span class="s2">&#34;01234-ABCDEF-56789&#34;</span>
}
</code></pre></div><p>何度もいうように Variables は API であり常にユーザに公開されている。つまりこの値をユーザは変更することができる。入力として正しくないものを弾く場合は validation を設定することで Input を制御することができるが、&ldquo;正しい Billing account かどうか&rdquo; を判断するのは難しい。こういったものは Variables として定義するべきではない。仮に作成する GCP プロジェクトごとに Billing account を変更できるようにするのであれば、ユーザが変更できない場所 (Locals) で定義した値を選択させるようなインターフェイスにするべきである。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># モジュール側
</span><span class="c1"></span><span class="k">variable</span> <span class="s2">&#34;gcp_billing_account&#34;</span> {
<span class="n">  type</span>    <span class="o">=</span> <span class="k">string</span>
<span class="n">  default</span> <span class="o">=</span> <span class="s2">&#34;account-a&#34;</span>

  <span class="k">validation</span> {
<span class="n">    condition</span>     <span class="o">=</span> <span class="k">contains</span><span class="p">([</span><span class="s2">&#34;account-a&#34;, &#34;account-b&#34;, &#34;account-c&#34;</span><span class="p">],</span> <span class="k">var</span><span class="p">.</span><span class="k">gcp_billing_account</span><span class="p">)</span>
<span class="n">    error_message</span> <span class="o">=</span> <span class="s2">&#34;Not allowed billing account.&#34;</span>
  }
}

<span class="k">locals</span> {
<span class="n">  billing_accounts</span> <span class="o">=</span> {
<span class="n">    account-a</span> <span class="o">=</span> <span class="s2">&#34;01234-ABCDEF-56789-A&#34;</span>
<span class="n">    account-b</span> <span class="o">=</span> <span class="s2">&#34;01234-ABCDEF-56789-B&#34;</span>
<span class="n">    account-c</span> <span class="o">=</span> <span class="s2">&#34;01234-ABCDEF-56789-C&#34;</span>
  }
}

<span class="k">resource</span> <span class="s2">&#34;google_project&#34; &#34;service&#34;</span> {
<span class="n">  count</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">gcp</span><span class="p">.</span><span class="k">enable</span> <span class="err">?</span> <span class="m">1</span> <span class="err">:</span> <span class="m">0</span>

<span class="n">  name</span>       <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">gcp_project_id</span>
<span class="n">  project_id</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">gcp_project_id</span>

<span class="n">  billing_account</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">billing_accounts</span><span class="p">[</span><span class="k">var</span><span class="p">.</span><span class="k">gcp_billing_account</span><span class="p">]</span>

<span class="n">  skip_delete</span> <span class="o">=</span> <span class="kt">false</span>
}
</code></pre></div><p>こうすることでユーザは紐付けたい Billing account を選んだ上で安全に Module に渡すことができ、Module としても予期せぬ文字列を受け取らないようにすることができる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># ユーザ側
</span><span class="c1"></span><span class="k">module</span> <span class="s2">&#34;myservice&#34;</span> {
<span class="n">  source</span> <span class="o">=</span> <span class="s2">&#34;git://...&#34;</span>

<span class="n">  gcp_billing_account</span> <span class="o">=</span> <span class="s2">&#34;account-a&#34;</span>
}
</code></pre></div><p>このように、ユーザに隠したい変数は可能な限り Locals に定義するべきである。Variables に定義するとユーザが変更できてしまうこと忘れてはいけない。</p>
<h2 id="output-としての-api">Output としての API</h2>
<p>Variables の例でもわかったように公開するべきものは慎重に選ぶ必要がある。Outputs についても同様で、常にユーザに参照されうることを考慮するべきである。ではどんな Outputs を定義するべきか。</p>
<p>PagerDuty を例に考えてみる。上でも説明したとおり、使いたい機能を選べるように Input Variables が定義されているとする。Module 内で作成するリソースについては多少の挙動を変更できる余地を残した上で可能な限り隠蔽する。こうすることでユーザに余分な選択を与えないようにできる (逆に多くのものの挙動を Module 外から操作できるように Variables を事細かく定義してユーザに公開する場合、それはインターフェイスとして優れておらず Module 内に閉じ込めないほうがいいリソースだといえる)。</p>
<p>良くない Variables の定義:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># モジュール側
</span><span class="c1"></span><span class="k">variable</span> <span class="s2">&#34;pagerduty&#34;</span> {
<span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;PagerDuty configurations&#34;</span>

<span class="n">  type</span> <span class="o">=</span> <span class="k">object</span><span class="p">(</span>{
<span class="n">    enable</span>  <span class="o">=</span> <span class="k">bool</span>
<span class="n">    service</span> <span class="o">=</span> <span class="k">object</span><span class="p">(</span>{
<span class="n">      support_hours</span> <span class="o">=</span> <span class="k">object</span><span class="p">(</span>{
<span class="n">        type</span>         <span class="o">=</span> <span class="k">string</span>
<span class="n">        time_zome</span>    <span class="o">=</span> <span class="k">string</span>
<span class="n">        start_time</span>   <span class="o">=</span> <span class="k">string</span>
<span class="n">        end_time</span>     <span class="o">=</span> <span class="k">string</span>
<span class="n">        days_of_week</span> <span class="o">=</span> <span class="k">list</span><span class="p">(</span><span class="k">string</span><span class="p">)</span>
      }<span class="p">)</span>
      <span class="p">...</span>
    }<span class="p">)</span>
    <span class="p">...</span>
  }<span class="p">)</span>
<span class="n">  default</span> <span class="o">=</span> {
<span class="n">    enable</span>  <span class="o">=</span> <span class="kt">false</span>
<span class="n">    service</span> <span class="o">=</span> {
<span class="n">      support_hours</span> <span class="o">=</span> {
<span class="n">        type</span>         <span class="o">=</span> <span class="s2">&#34;fixed_time_per_day&#34;</span>
<span class="n">        time_zone</span>    <span class="o">=</span> <span class="s2">&#34;America/Lima&#34;</span>
<span class="n">        start_time</span>   <span class="o">=</span> <span class="s2">&#34;09:00:00&#34;</span>
<span class="n">        end_time</span>     <span class="o">=</span> <span class="s2">&#34;17:00:00&#34;</span>
<span class="n">        days_of_week</span> <span class="o">=</span> <span class="p">[</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span><span class="p">]</span>
      }
      <span class="p">...</span>
    }
    <span class="p">...</span>
  }
}
</code></pre></div><p>Module とは抽象度を上げるためのものであるのにも関わらず、これほどまで多くの項目を Variables に定義して Module 外部から変更できるようにする場合、それは Module に含めるリソースであるのかどうかを改めて考える必要がある。</p>
<p>こうしたリソースを Module に入れない場合、ユーザが自分たちで定義する必要が出てくる。そのとき、Module 内で作成したリソースやデータとやりとりをするためのブリッヂになるのが Outputs である。</p>
<p>以下のものが service-kit というサービス立ち上げに必要なツールセットを作成する Module で定義されており、</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ls  modules/service-kit/pagerduty_*
<span class="go">pagerduty_escalation_policy.tf
</span><span class="go">pagerduty_schedule.tf
</span><span class="go">pagerduty_service.tf
</span><span class="go">pagerduty_user.tf
</span></code></pre></div><p>以下のものが Root Module (ユーザによる service-kit の呼び出し元) にあるとする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>ls
<span class="go">pagerduty_ruleset.tf
</span><span class="go">pagerduty_ruleset_rule.tf
</span></code></pre></div><p>PagerDuty Ruleset は Module 側で定義されておらず (設定項目がユーザに依存しすぎて抽象化できなかったとする)、ユーザが自身で定義する必要がある。</p>
<p><a href="https://registry.terraform.io/providers/PagerDuty/pagerduty/latest/docs/resources/ruleset_rule#route">pagerduty_ruleset_rule</a> では PagerDuty Service の Service ID を参照する箇所がある。PagerDuty Service (pagerduty_service.tf) は Module 側に定義されており、ユーザは参照することができない。しかし、Service ID をハードコードするのではなく、リソース参照により取得したいと考える。</p>
<p>このようなユースケースでは <a href="https://registry.terraform.io/providers/PagerDuty/pagerduty/latest/docs/resources/service#id">pagerduty_service.*.id</a> は Outputs として公開するべきといえる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># モジュール側
</span><span class="c1"></span><span class="k">output</span> <span class="s2">&#34;pagerduty_service_id&#34;</span> {
<span class="n">  value</span> <span class="o">=</span> <span class="k">pagerduty_service</span><span class="p">.</span><span class="k">service</span><span class="p">.</span><span class="k">id</span>
}
</code></pre></div><p>こうすることでユーザは自分で定義した pagerduty_ruleset_rule から参照することができる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># ユーザ側
</span><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;pagerduty_ruleset_rule&#34; &#34;service&#34;</span> {
<span class="n">  ruleset</span>  <span class="o">=</span> <span class="k">data</span><span class="p">.</span><span class="k">pagerduty_ruleset</span><span class="p">.</span><span class="k">default_global</span><span class="p">.</span><span class="k">id</span>
  <span class="p">...</span>
  <span class="k">actions</span> {
    <span class="k">route</span> {
<span class="n">      value</span> <span class="o">=</span> <span class="k">module</span><span class="p">.</span><span class="k">myservice</span><span class="p">.</span><span class="k">pagerduty_service_id</span><span class="c1"> # &#34;AB1C23D&#34; のような値を書かなくて良い
</span><span class="c1"></span>    }
  }
  <span class="p">...</span>
}
</code></pre></div><h2 id="root-module-の場合は-variables-を使うかlocals-を使うか">Root Module の場合は Variables を使うか、Locals を使うか</h2>
<p>Root Module とはユーザが .tf ファイルを置いたディレクトリである。Module 外から振る舞いの変更や Outputs が参照される可能性が低い。</p>
<p>おそらく Terraform のユースケースとして Root Module が一番多いため、Locals を使うか Variables を使うか曖昧になっているケースが多いと感じる。Root Module では Token の設定など Git 管理できないものなどを外から注入するユースケースを除き、Module での考えと同じように Locals を優先して使って問題ない。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># ユーザ側
</span><span class="c1"></span><span class="k">variable</span> <span class="s2">&#34;pagerduty_token&#34;</span> {
<span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;PagerDuty token&#34;</span>
}
</code></pre></div><p>(variable の default を書かないことで Git に含めないで環境変数やプロンプト経由で Terraform に渡すことができる)</p>
<h2 id="まとめ">まとめ</h2>
<ul>
<li>Variables は API である。公開するものは常にユーザによって上書きされる可能性がある</li>
<li>Variables は多くを定義しないほうが良い。定義が多い場合、ユーザに選択させすぎている良くないインターフェイスかもしれない</li>
<li>Module 内部に閉じ込めておきたい変数は Locals に書く。必然的に Locals での定義が一番多くなるべきである</li>
<li>Outputs も多くを定義しない。Variables 同様に API としての側面を持つ。Module 内と外をつなぐブリッヂとして必要なユースケースが考えられる場合のみ定義する</li>
<li>公開した API (Variables / Outputs) は変更が難しい。変えたい場合は Versioning をして Module の Release note などで破壊的変更があることをユーザに知らせる必要がある</li>
</ul>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2022 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



