
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="Terraform の count と for_each の使い分けと Splat Expressions について - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2022/06/12/terraform-count-for-each/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>Terraform の count と for_each の使い分けと Splat Expressions について | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">Terraform の count と for_each の使い分けと Splat Expressions について</h1>
    <h2 class="subtitle is-5">June 12, 2022 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/terraform">terraform</a>
    
</div>

    
    <br>
    <div class="content">
      <h2 id="count-と-for_each">count と for_each</h2>
<p>Terraform には &ldquo;繰り返す&rdquo; 処理として <a href="https://www.terraform.io/language/meta-arguments/count">count</a> と <a href="https://www.terraform.io/language/meta-arguments/for_each">for_each</a> がある。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">resource</span> <span class="s2">&#34;aws_instance&#34; &#34;server&#34;</span> {
<span class="n">  count</span> <span class="o">=</span> <span class="m">4</span><span class="c1"> # create four similar EC2 instances
</span><span class="c1"></span>
<span class="n">  ami</span>           <span class="o">=</span> <span class="s2">&#34;ami-a1b2c3d4&#34;</span>
<span class="n">  instance_type</span> <span class="o">=</span> <span class="s2">&#34;t2.micro&#34;</span>

<span class="n">  tags</span> <span class="o">=</span> {
<span class="n">    Name</span> <span class="o">=</span> <span class="s2">&#34;Server ${count.index}&#34;</span>
  }
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">resource</span> <span class="s2">&#34;aws_iam_user&#34; &#34;the-accounts&#34;</span> {
<span class="n">  for_each</span> <span class="o">=</span> <span class="k">toset</span><span class="p">(</span> <span class="p">[</span><span class="s2">&#34;Todd&#34;, &#34;James&#34;, &#34;Alice&#34;, &#34;Dottie&#34;</span><span class="p">]</span> <span class="p">)</span>
<span class="n">  name</span>     <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">key</span>
}
</code></pre></div><p>どちらも for ループとして利用できるが count はリソースを配列として作成し、for_each はマップとして作成する (リソースは state に保存されこのときの状態の持ち方が配列とマップという違いがある)。また、for_each では配列とマップの型を渡すことができ、配列を渡す場合は明示的に <a href="https://www.terraform.io/language/functions/toset"><code>toset</code></a> で <a href="https://www.terraform.io/language/expressions/type-constraints#collection-types">Set</a> (重複する値がないことが保証された配列) に変換して渡す必要がある。マップはそのまま渡す。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># for_each に Map を渡す
</span><span class="c1"></span><span class="k">resource</span> <span class="s2">&#34;azurerm_resource_group&#34; &#34;rg&#34;</span> {
<span class="n">  for_each</span> <span class="o">=</span> {
<span class="n">    a_group</span> <span class="o">=</span> <span class="s2">&#34;eastus&#34;</span>
<span class="n">    another_group</span> <span class="o">=</span> <span class="s2">&#34;westus2&#34;</span>
  }
<span class="n">  name</span>     <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">key</span>
<span class="n">  location</span> <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">value</span>
}
</code></pre></div><p>for_each ではループしたあとの配列 (もしくはマップ) の各要素は <a href="https://www.terraform.io/language/meta-arguments/for_each#the-each-object">each</a> というオブジェクトで参照する。Map の場合は、each.key でキーが each.value で値が参照でき、配列 (Set) の場合は、each.key と each.value のどちらを使っても参照できる。</p>
<p>count の場合は <a href="https://www.terraform.io/language/meta-arguments/count#count-index">count.index</a> という定義済みの attribute でループ中の index を参照することができる。</p>
<h2 id="count-と-for_each-の使い分け">count と for_each の使い分け</h2>
<p><strong>基本的に count を使用しない</strong>。count だとリソースのアドレス (state) が配列となり、途中のリソースを削除するとその index が飛ぶので Terraform が配列の詰め直しをしてしまう。それにより、リソースの削除と作成が行われてしまい予期せぬアクシデントを引き起こす可能性がある。</p>
<p>例えば、次のようなリソースの定義があるとする。<a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_service">google_project_service</a> は指定した GCP プロジェクトで使用するサービスの API を有効化するリソースである。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">variable</span> <span class="s2">&#34;gcp_enabled_services&#34;</span> {
<span class="n">  type</span> <span class="o">=</span> <span class="k">list</span><span class="p">(</span><span class="k">string</span><span class="p">)</span>

<span class="n">  default</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&#34;bigquery.googleapis.com&#34;</span><span class="p">,</span>
    <span class="s2">&#34;compute.googleapis.com&#34;</span><span class="p">,</span>
    <span class="s2">&#34;container.googleapis.com&#34;</span><span class="p">,</span>
    <span class="s2">&#34;iam.googleapis.com&#34;</span><span class="p">,</span>
    <span class="s2">&#34;...&#34;</span><span class="p">,</span>
  <span class="p">]</span>
}

<span class="k">resource</span> <span class="s2">&#34;google_project_service&#34; &#34;api&#34;</span> {
<span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">var</span><span class="p">.</span><span class="k">gcp_enabled_services</span><span class="p">)</span>

<span class="n">  project</span> <span class="o">=</span> <span class="k">google_project</span><span class="p">.</span><span class="k">service</span><span class="p">.</span><span class="k">project_id</span>
<span class="n">  service</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">gcp_enabled_services</span><span class="p">[</span><span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">]</span>
}
</code></pre></div><p>ここで、例えば BigQuery を使わなくなったとして、variable の配列から削除すると以降の index が詰め直しによりリソースの再作成が行われてしまう。それにより、一時的にサービスが無効化され利用できなくなる可能性がある。Cloud SQL の API が disable され通信できなくなるなど想像するとおぞましい。</p>
<p>(ちなみに <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_service">google_project_service</a> には <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project_service#disable_on_destroy">disable_on_destroy</a> という Argument がある。True だと、リソースの削除のときにサービスを無効化する。これを false にすることで Terraform から無効化することを防ぐことができる。デフォルトは True)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform state list
<span class="go">module.myservice.google_project_service.api[0]  # &lt;-- &#34;bigquery.googleapis.com&#34;
</span><span class="go">module.myservice.google_project_service.api[1]
</span><span class="go">module.myservice.google_project_service.api[2]
</span><span class="go">module.myservice.google_project_service.api[3]
</span><span class="go">...
</span></code></pre></div><p>また、削除ではなく追加する場合でも配列の末尾に追加しないと、index がずれてそれ以降のindex 詰め直しによる再作成が行われる。実質配列のソートはできない。</p>
<p>この問題は for_each に書き直すことで解決する。リソースのアドレス (state) はマップとして作成されるので途中のキーを消しても他のリソースに影響を与えない。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">resource</span> <span class="s2">&#34;google_project_service&#34; &#34;api&#34;</span> {
<span class="n">  for_each</span> <span class="o">=</span> <span class="k">toset</span><span class="p">(</span><span class="k">var</span><span class="p">.</span><span class="k">gcp_enabled_services</span><span class="p">)</span>

<span class="n">  project</span> <span class="o">=</span> <span class="k">google_project</span><span class="p">.</span><span class="k">service</span><span class="p">.</span><span class="k">project_id</span>
<span class="n">  service</span> <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">key</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform state list
<span class="go">module.myservice.google_project_service.api[&#34;bigquery.googleapis.com&#34;]
</span><span class="go">module.myservice.google_project_service.api[&#34;compute.googleapis.com&#34;]
</span><span class="go">module.myservice.google_project_service.api[&#34;container.googleapis.com&#34;]
</span><span class="go">module.myservice.google_project_service.api[&#34;iam.googleapis.com&#34;]
</span><span class="go">...
</span></code></pre></div><p>参考:</p>
<p><a href="https://www.terraform.io/language/meta-arguments/count#when-to-use-for_each-instead-of-count">When to Use <code>for_each</code> Instead of <code>count</code></a></p>
<blockquote>
<p>If your instances are almost identical, <code>count</code> is appropriate. If some of their arguments need distinct values that can&rsquo;t be directly derived from an integer, it&rsquo;s safer to use <code>for_each</code>.
Before <code>for_each</code> was available, it was common to derive count from the length of a list and use <code>count.index</code> to look up the original list value:</p>
</blockquote>
<p>for_each が追加される前は count によるリソース作成が常套句として用いられていた。ドキュメントにもある通り、for_each が導入された Terraform 0.12.6 以降はこちらを使用したほうが安全なケースが多い。また、count と for_each は同じリソース内に同居できない。</p>
<h2 id="count-を使うとき">count を使うとき</h2>
<p>基本的に count を使用しないが、例外がある。count が 0 か 1 となる場合である。0 は作成しない、1 は 1 つ作成する (index が 0 番固定になり、詰め直しが発生しない)。</p>
<p>count を使用したリソース作成有無 (0/1) の判定は昔から行われていた手法であるが、その場合においては count を使うほうが好ましい。
この例は enable_gcp という variable が true のときに <a href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_project">google_project</a> のリソースの作成を行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">resource</span> <span class="s2">&#34;google_project&#34; &#34;service&#34;</span> {
<span class="n">  count</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">enable_gcp</span> <span class="err">?</span> <span class="m">1</span> <span class="err">:</span> <span class="m">0</span>

<span class="n">  name</span>       <span class="o">=</span> <span class="s2">&#34;My Service Production&#34;</span>
<span class="n">  project_id</span> <span class="o">=</span> <span class="s2">&#34;my-service-prod&#34;</span>
}
</code></pre></div><p>false のときは 0 となり、リソースは作成されない。<a href="https://www.terraform.io/language/modules/syntax">Module</a> などで variable (公開したパラメータ) で flag のような挙動を実装するときに使うことができる。</p>
<h2 id="splat-expressions">Splat Expressions</h2>
<p><a href="https://www.terraform.io/language/expressions/splat"><em>splat expression</em></a> とは <a href="https://www.terraform.io/language/expressions/for"><em>for expression</em></a> を簡潔に表した表現方法である。</p>
<p><a href="https://registry.terraform.io/providers/PagerDuty/pagerduty/latest/docs/data-sources/user">pagerduty_user</a> という <a href="https://www.terraform.io/language/data-sources">Data source</a> が count によって複数個、作成されている場合、splat で次のように参照することができる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">data</span> <span class="s2">&#34;pagerduty_user&#34; &#34;oncall_members&#34;</span> {
<span class="n">  count</span> <span class="o">=</span> <span class="k">length</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">service_users</span><span class="p">)</span>
<span class="n">  email</span> <span class="o">=</span> <span class="k">element</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">service_users</span><span class="p">,</span> <span class="k">count</span><span class="p">.</span><span class="k">index</span><span class="p">)</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">data</span><span class="p">.</span><span class="k">pagerduty_user</span><span class="p">.</span><span class="k">oncall_members</span><span class="p">[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform state list
<span class="go">module.your_service.data.pagerduty_user.oncall_members[0]
</span><span class="go">module.your_service.data.pagerduty_user.oncall_members[1]
</span><span class="go">module.your_service.data.pagerduty_user.oncall_members[2]
</span></code></pre></div><p>for_each の場合は、<a href="https://www.terraform.io/language/functions/values">values</a> を使って参照する。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">data</span> <span class="s2">&#34;pagerduty_user&#34; &#34;oncall_members&#34;</span> {
<span class="n">  for_each</span> <span class="o">=</span> <span class="k">toset</span><span class="p">(</span><span class="k">local</span><span class="p">.</span><span class="k">service_users</span><span class="p">)</span>
<span class="n">  email</span>    <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">key</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">values</span><span class="p">(</span><span class="k">data</span><span class="p">.</span><span class="k">pagerduty_user</span><span class="p">.</span><span class="k">oncall_members</span><span class="p">)[</span><span class="err">*</span><span class="p">].</span><span class="k">id</span>
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform state list
<span class="go">module.your_service.data.pagerduty_user.oncall_members[&#34;babarot@xxx.com&#34;]
</span><span class="go">module.your_service.data.pagerduty_user.oncall_members[&#34;foo@xxx.com&#34;]
</span><span class="go">module.your_service.data.pagerduty_user.oncall_members[&#34;bar@xxx.com&#34;]
</span></code></pre></div><ul>
<li><a href="https://github.com/hashicorp/terraform/issues/22476">for_each and splat · Issue #22476 · hashicorp/terraform</a></li>
<li><a href="https://github.com/hashicorp/terraform/issues/23245">Output complains about missing attribute when it is shurely present · Issue #23245 · hashicorp/terraform</a></li>
</ul>
<h2 id="legacy-splat-expressions">Legacy Splat Expressions</h2>
<p>以前のバージョンでは splat は次のように表現していた。後方互換性を維持するために、まだサポートされ続けているが新しい設定ではおすすめされない。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">data</span><span class="p">.</span><span class="k">pagerduty_user</span><span class="p">.</span><span class="k">oncall_members</span><span class="p">.</span><span class="err">*</span><span class="p">.</span><span class="k">id</span>
</code></pre></div>
    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2022 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



