
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="Terraform の object variable で柔軟なパラメータ設定を提供する (optional default) - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2022/07/03/terraform-optional-attributes-for-object-type-constraints/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>Terraform の object variable で柔軟なパラメータ設定を提供する (optional default) | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">Terraform の object variable で柔軟なパラメータ設定を提供する (optional default)</h1>
    <h2 class="subtitle is-5">July 3, 2022 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/terraform">terraform</a>
    
</div>

    
    <br>
    <div class="content">
      <h2 id="object-variable-の-optional-default-とは">object variable の optional default とは</h2>
<p>Terraform v1.3.0 から object variable の optional default が使えるようになる (現在は experimental で <a href="https://github.com/hashicorp/terraform/releases/tag/v1.3.0-alpha20220622">v1.3.0-alpha</a> で利用可能)</p>
<ul>
<li><a href="https://github.com/hashicorp/terraform/issues/19898">Optional arguments in object variable type definition · Issue #19898 · hashicorp/terraform</a></li>
<li><a href="https://github.com/hashicorp/terraform/issues/30750">[Request] module_variable_optional_attrs: Optional default · Issue #30750 · hashicorp/terraform</a></li>
</ul>
<p>どういう機能かというと、object type の variable にて、object attribute (object の key に対応する value) で optional() を設定したときに一緒に default value を指定できるようにするもの。</p>
<p>こうすることで optional のパラメータ (object attribute) に対してユーザからの Input がなかった場合、null ではなく指定した default value が使用される。</p>
<p>例: 次のような variable があるとき</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="k">variable</span> <span class="s2">&#34;with_optional_attribute&#34;</span> {
<span class="n">  type</span> <span class="o">=</span> <span class="k">object</span><span class="p">(</span>{
<span class="n">    a</span> <span class="o">=</span> <span class="k">string</span><span class="c1">                # a required attribute
</span><span class="c1"></span><span class="n">    b</span> <span class="o">=</span> <span class="k">optional</span><span class="p">(</span><span class="k">string</span><span class="p">)</span><span class="c1">      # an optional attribute
</span><span class="c1"></span><span class="n">    c</span> <span class="o">=</span> <span class="k">optional</span><span class="p">(</span><span class="k">number</span><span class="p">,</span> <span class="m">127</span><span class="p">)</span><span class="c1"> # an optional attribute with a default value
</span><span class="c1"></span>  }<span class="p">)</span>
}
</code></pre></div><p>以下の値を引数 (Input) で渡して plan してみると、</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan -var<span class="o">=</span><span class="s1">&#39;with_optional_attribute={&#34;a&#34;=&#34;foo&#34;}&#39;</span>
<span class="go">Changes to Outputs:
</span><span class="go">  + with_optional_attribute = {
</span><span class="go">      + a = &#34;foo&#34;
</span><span class="go">      + b = null
</span><span class="go">      + c = 127
</span><span class="go">    }
</span></code></pre></div><ul>
<li><code>a</code> (required): Input で指定された foo</li>
<li><code>b</code> (optional): Input がなく default value がないため null</li>
<li><code>c</code> (optional): Input がないが default value が指定されているので 127</li>
</ul>
<p>で更新されていることがわかる。</p>
<h2 id="どういうときに使えるか">どういうときに使えるか</h2>
<p>モジュール開発者が object type の variable を使って設定変更のインターフェイス<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>を提供している場合を考える。モジュール開発者は新しい機能を追加したときに、モジュール利用者がその設定を変更できるように attribute もあわせて追加するとする。</p>
<p>そのとき、モジュール利用者がその attribute をたとえ使わなかったとしても (= default value でよかったとしても) 同じようにモジュールファイル側で追加しないと attribute 不足エラーになってしまう。つまりモジュールをアップグレードしただけで、設定ファイルを変更していないのにもかかわらず plan が通らなくなってしまう。</p>
<p>これを回避するには、モジュールのバージョン管理をするしかない。利用するモジュールのバージョンを固定することで、latest に変更があったとしても plan に影響が出ないようにする。基本的にこれは正しい方法で、とくに Module Registory を使う場合などについては Terraform としてもモジュールのバージョン管理することを推奨されている。しかし必ずしもそうではない場合 (local source など) は都度エラーに対応する必要があった <em>(これについては、新しいバージョンが公開されたら上げ続ける or 上げるようにお願いして回る必要があるという面倒くさい作業が発生するジレンマがある)</em>。</p>
<p>しかし、この default optional をうまく使うことでユーザに不用意な対応をお願いすることなく (バージョン管理を強要することなく)、新しいインターフェイスを提供することができるようになった。また、モジュールファイル側に必ずしもすべての attribute を記載する必要がなくなったのでファイル自体の見通しも良くなる。</p>
<p>例えば以下のような設定が object variable によって提供されていた場合を考える。この例ではすべての attribute を記述しているが、実際にユーザが default から値を変えているのは schedule.interval だけである。つまり、他の設定については変更する必要がないのでファイルに記述する必要がない。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># (before)
</span><span class="c1"></span><span class="n">pagerduty</span> <span class="o">=</span> {
<span class="n">  enable</span> <span class="o">=</span> <span class="kt">true</span>
<span class="n">  service</span> <span class="o">=</span> {
<span class="n">    support_hours</span> <span class="o">=</span> {
<span class="n">      start_time</span>   <span class="o">=</span> <span class="s2">&#34;09:00:00&#34;</span><span class="c1"> # default
</span><span class="c1"></span><span class="n">      end_time</span>     <span class="o">=</span> <span class="s2">&#34;17:00:00&#34;</span><span class="c1"> # default
</span><span class="c1"></span><span class="n">      days_of_week</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;Mon&#34;, &#34;Tue&#34;, &#34;Wed&#34;, &#34;Thu&#34;, &#34;Fri&#34;</span><span class="p">]</span><span class="c1"> # default
</span><span class="c1"></span>    }
  }
<span class="n">  schedule</span> <span class="o">=</span> {
<span class="n">    create</span>   <span class="o">=</span> <span class="kt">true</span>
<span class="n">    timezone</span> <span class="o">=</span> <span class="s2">&#34;Asia/Tokyo&#34;</span><span class="c1"> # default
</span><span class="c1"></span><span class="n">    interval</span> <span class="o">=</span> <span class="s2">&#34;30m&#34;</span><span class="c1">        # default is 5m
</span><span class="c1"></span>  }
}
</code></pre></div><p>それを optional default によって他を省略することができるので設定ファイルは次のようになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># (after)
</span><span class="c1"></span><span class="n">pagerduty</span> <span class="o">=</span> {
<span class="n">  enable</span> <span class="o">=</span> <span class="kt">true</span>
<span class="n">  schedule</span> <span class="o">=</span> {
<span class="n">    create</span>   <span class="o">=</span> <span class="kt">true</span>
<span class="n">    interval</span> <span class="o">=</span> <span class="s2">&#34;30m&#34;</span><span class="c1"> # default is 5m
</span><span class="c1"></span>  }
}
</code></pre></div><h2 id="object-of-object-で-object-自体を-optional-にする場合">object of object で object 自体を optional にする場合</h2>
<p>この場合、object of object は pagerduty.schedule で pagerduty.schedule.timezone を optional にし、そもそも pagerduty.schedule 自体も optional にしようというケース (pagerduty.schedule object を新たに追加したユースケース) を考える。</p>
<p>次の HCL が期待した動作をする。</p>
<ul>
<li>pagerduty.schedule (object) 自体を optional にする</li>
<li>pagerduty.schedule (object) の中の attribute をそれぞれ optional にする</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># main.tf
</span><span class="c1"></span>
<span class="k">terraform</span> {
<span class="n">  experiments</span> <span class="o">=</span> <span class="p">[</span><span class="k">module_variable_optional_attrs</span><span class="p">]</span>
}

<span class="k">variable</span> <span class="s2">&#34;pagerduty&#34;</span> {
<span class="n">  description</span> <span class="o">=</span> <span class="s2">&#34;PagerDuty configurations&#34;</span>

<span class="n">  type</span> <span class="o">=</span> <span class="k">object</span><span class="p">(</span>{
<span class="n">    enable</span> <span class="o">=</span> <span class="k">optional</span><span class="p">(</span><span class="k">bool</span><span class="p">,</span> <span class="kt">false</span><span class="p">)</span>
<span class="n">    schedule</span> <span class="o">=</span> <span class="k">optional</span><span class="p">(</span>
      <span class="k">object</span><span class="p">(</span>{
<span class="n">        create</span>   <span class="o">=</span> <span class="k">optional</span><span class="p">(</span><span class="k">bool</span><span class="p">,</span> <span class="kt">false</span><span class="p">)</span>
<span class="n">        timezone</span> <span class="o">=</span> <span class="k">optional</span><span class="p">(</span><span class="k">string</span><span class="p">,</span> <span class="s2">&#34;Asia/Tokyo&#34;</span><span class="p">)</span>
      }<span class="p">),</span>
      {
<span class="n">        create</span>   <span class="o">=</span> <span class="kt">false</span>
<span class="n">        timezone</span> <span class="o">=</span> <span class="s2">&#34;Asia/Tokyo&#34;</span>
      }
    <span class="p">)</span>
  }<span class="p">)</span>
}

<span class="k">output</span> <span class="s2">&#34;pagerduty&#34;</span> {
<span class="n">  value</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">pagerduty</span>
}
</code></pre></div><h3 id="1-object-の中身-scheduletimezone-を省略した場合">1. object の中身 (schedule.timezone) を省略した場合</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># example.tfvars
</span><span class="c1"></span><span class="n">pagerduty</span> <span class="o">=</span> {
<span class="n">  enable</span> <span class="o">=</span> <span class="kt">true</span>
<span class="n">  schedule</span> <span class="o">=</span> {
<span class="n">    create</span> <span class="o">=</span> <span class="kt">true</span>
  }
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan -var-file<span class="o">=</span>example.tfvars
<span class="go">Changes to Outputs:
</span><span class="go">  + pagerduty = {
</span><span class="go">      + enable   = true
</span><span class="go">      + schedule = {
</span><span class="go">          + create   = true
</span><span class="go">          + timezone = &#34;Asia/Tokyo&#34;
</span><span class="go">        }
</span><span class="go">    }
</span></code></pre></div><h3 id="2-object-schedule-自体を省略した場合">2. object (schedule) 自体を省略した場合</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="c1"># example.tfvars
</span><span class="c1"></span><span class="n">pagerduty</span> <span class="o">=</span> {
<span class="n">  enable</span> <span class="o">=</span> <span class="kt">true</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan -var-file<span class="o">=</span>example.tfvars
<span class="go">Changes to Outputs:
</span><span class="go">  + pagerduty = {
</span><span class="go">      + enable   = true
</span><span class="go">      + schedule = {
</span><span class="go">          + create   = false
</span><span class="go">          + timezone = &#34;Asia/Tokyo&#34;
</span><span class="go">        }
</span><span class="go">    }
</span></code></pre></div><h2 id="optional-にする必要性">optional にする必要性</h2>
<p>最後に、optional にする必要性を振り返る。</p>
<p>バージョン管理をしていないモジュールの場合、もしくはしているが、ユーザに不本意な attribute 不足によるエラーを生じさせたくないといった場合に optional default を使うと良いことがわかった。</p>
<p>一方で、attribute 不足によるエラーを出したほうがいい場合もある。例えば、バージョン管理をしている前提で新しい attribute を追加した場合、optional になっている attribute についてはリリースノートなどを確認しない限り知ることができない。基本的に新しい機能を提供する場合、既存に影響が出ないように (= plan に diff が発生しないように) するべきだが、そうできない場合は optional ではないほうが優しい UX といえる。</p>
<p>どんなインターフェイスやモジュールの利用体験になっていると良いかを考えて (e.g. attribute をはやしすぎて機能変更を許しすぎてないだろうか、default value は何がふさわしいだろうか) optional default や object variable を使っていく必要がある。</p>
<h3 id="良くない例-アップグレード-v020-したら-diff-が出る-pagerduty-の-schedule-リソースを作成する-pagerdutycreate_schedule-の-default-が-true-なことでアップグレードした瞬間にモジュールがリソースを作ろうとする">良くない例: アップグレード (v0.2.0) したら diff が出る (PagerDuty の Schedule リソースを作成する pagerduty.create_schedule の default が true なことでアップグレードした瞬間にモジュールがリソースを作ろうとする)</h3>
<p>v0.2.0 にする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="n">version</span> <span class="o">=</span> <span class="s2">&#34;v0.2.0&#34;</span>

<span class="n">pagerduty</span> <span class="o">=</span> {
<span class="n">  enable</span> <span class="o">=</span> <span class="kt">true</span>
}
</code></pre></div><p>上げたら何か追加されそうになる。どんな attribute が追加されたか、またそれでどのようなリソースを作ろうとしているのか調べる必要がある。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan
<span class="go">...
</span><span class="go">Plan: 2 to add, 0 to change, 0 to destroy.
</span></code></pre></div><h3 id="良い例-アップグレードしたら-v020-attribute-不足エラーになるそのタイミングでどんな-attribute-を追加するべきかを知ることができtrue-にするか-false-にするか選ぶことができる">良い例: アップグレードしたら (v0.2.0) attribute 不足エラーになる。そのタイミングでどんな attribute を追加するべきかを知ることができ、true にするか false にするか選ぶことができる</h3>
<p>v0.2.0 にする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="n">version</span> <span class="o">=</span> <span class="s2">&#34;v0.2.0&#34;</span>

<span class="n">pagerduty</span> <span class="o">=</span> {
<span class="n">  enable</span> <span class="o">=</span> <span class="kt">true</span>
}
</code></pre></div><p>attribute 不足エラーになる。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan
<span class="go">| Error: Invalid value for input variable
</span><span class="go">|
</span><span class="go">|   on module_service_kit.tf line 21, in module &#34;service-a&#34;:
</span><span class="go">|   21:   pagerduty = {
</span><span class="go">|   22:     enable = true
</span><span class="go">|   24:   }
</span><span class="go">|
</span><span class="go">| The given value is not suitable for module.service-a.var.pagerduty declared at ...
</span><span class="go">| &#34;create_schedule&#34; is required.
</span></code></pre></div><p>create_schedule (default は true) を追加した上で明示的に false にする</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="n">version</span> <span class="o">=</span> <span class="s2">&#34;v0.2.0&#34;</span>

<span class="n">pagerduty</span> <span class="o">=</span> {
<span class="n">  enable</span>          <span class="o">=</span> <span class="kt">true</span>
<span class="n">  create_schedule</span> <span class="o">=</span> <span class="kt">false</span>
}
</code></pre></div><p>アップグレードしたことによるリソース変更がなく今まで通り。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>terraform plan
<span class="go">...
</span><span class="go">No changes. Your infrastructure matches the configuration.
</span></code></pre></div><section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Terraform の variable は &ldquo;変数&rdquo; ではなく、Module の挙動を外部から変更するためのインターフェイスである <a href="https://tellme.tokyo/post/2022/06/15/terraform-variables-is-api/">https://tellme.tokyo/post/2022/06/15/terraform-variables-is-api/</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2022 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



