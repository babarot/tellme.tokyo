
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="ディレクトリ移動系プラグイン「enhancd」の実装 - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2015/08/16/092849/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>ディレクトリ移動系プラグイン「enhancd」の実装 | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">ディレクトリ移動系プラグイン「enhancd」の実装</h1>
    <h2 class="subtitle is-5">August 16, 2015 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/bash">bash</a>
    
        <a class="button is-link" href="/tags/shellscript">shellscript</a>
    
        <a class="button is-link" href="/tags/zsh">zsh</a>
    
</div>

    
    <br>
    <div class="content">
      <h1 id="まえがき">まえがき</h1>
<p><img src="https://raw.githubusercontent.com/b4b4r07/screenshots/master/enhancd/logo.gif" alt=""></p>
<iframe
  class="hatenablogcard"
  style="width:100%;height:155px;max-width:420px;"
  src="https://hatenablog-parts.com/embed?url=http%3a%2f%2fqiita.com%2fb4b4r07%2fitems%2f2cf90da00a4c2c7b7e60"
  title=""
  width="300"
  height="150"
  frameborder="0"
  scrolling="no">
</iframe>

<p>という記事を Qiita に投稿してみるやいなや、予想以上の反響がありとても焦りました。これは「自分はディレクトリ移動に関してこんな効率化を行っているよ」という Tips なのですが、その際に使ったプラグイン（と言っても自分で作ったのですが）の使い方などをまとめてあるだけの記事です。</p>
<p>Qiita に投稿するときに enhancd についてたくさんを書きすぎても、そもそも ehancd をまず知りもしない人が見るときに困惑するだけだなと思い</p>
<p>、その基本的な動き方（ギミックなど）と使い方の紹介にとどめていました。ところが、これも驚いたことに、予想以上のプルリクエストが来たり、バグレポートがあがったりして「これは実装部分についても言及したいぞ」と思い、ここにまとめることにしました。</p>
<p>注意（以下である体になるのは仕様です）</p>
<h1 id="enhancd-の構想">enhancd の構想</h1>
<p>enhancd は基本的にシンプルな機能しか持ち合わせていない。これは長きに渡りシェルスクリプトを書いてみてよくわかったことがあってのことで、それは「ミニマルでイナフがシンプルへの一番の最適解」であるということ。この考えは UNIX の思想にも似通う。</p>
<p>まず欲しい機能を列挙した。</p>
<ul>
<li>今っぽく（というか今流行の）<code>peco</code> とか <code>percol</code> でディレクトリ選択したい</li>
<li>きちんとしたパスじゃなくても、移動履歴からよしなに補完して移動を可能にしたい</li>
</ul>
<p>この2つは互いに相乗効果が見込めるし、この方向性で詰めるて問題はなさそうだ。それともう一つ。既存の何かを強化するときに大事にしていることは、既にあるその機能をきちんと「強化する」方向性であるかどうかということ。例えば、<code>cd -</code>（一つ前のディレクトリに戻る）が「戻る」系の機能ではなく、全く違う別の何かに成り果てることはユーザを戸惑わせるだけだし、とてもナンセンスかなと。<code>cd</code> の名前を背負うのだから、既にある機能を尊重しつつ高めるものでなければならない。全く別の機能で塗り替えちゃうことはよくない。</p>
<p><img src="https://raw.githubusercontent.com/b4b4r07/screenshots/master/enhancd/demo.gif" alt=""></p>
<h1 id="enhancd-の実装">enhancd の実装</h1>
<p>enhancd には現在、23の関数が定義されていて、それらは2つに大別できる。</p>
<ul>
<li>enhancd 以外でも使えるような一般的なユーティリティ関数</li>
<li>enhancd の機能やそれを補佐するような専用の関数</li>
</ul>
<p>前者と後者を見分けるために、後者の関数名のプレフィックスには <code>cd::</code> が付いている。</p>
<p>次は専用関数の実装について言及する。</p>
<h2 id="cdcd"><code>cd::cd</code></h2>
<p>これはユーザが実質の <code>cd</code> として呼ぶ関数だ（実は <code>cd</code> はこれのエイリアスになっている）。</p>
<p>きちんと経路が辿れ、すでに存在している場合は通常の <code>cd</code> として振る舞う。辿れない場合こそが…enhancd の本領発揮である。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cd::cd<span class="o">()</span>
<span class="o">{</span>
<span class="c1"># ... 中略</span>

<span class="k">if</span> <span class="o">[</span> -d <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">builtin</span> <span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
<span class="k">else</span>
    <span class="c1"># t という変数にリストを作る</span>
    <span class="c1"># cd::cd が引数なしで実行されたとき、既存の cd を尊重した動きをする</span>
    <span class="k">if</span> empty <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
        <span class="nv">t</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="o">{</span> cd::cat_log<span class="p">;</span> <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$HOME</span><span class="s2">&#34;</span><span class="p">;</span> <span class="o">}</span> <span class="p">|</span> cd::list<span class="k">)</span><span class="s2">&#34;</span>
    <span class="k">else</span>
        <span class="nv">t</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>cd::list <span class="p">|</span> cd::narrow <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
    <span class="k">fi</span>

    <span class="c1"># t を cd::interfaece に渡す</span>
    <span class="c1"># t が空（リストなし）のときは $1 を渡す</span>
    cd::interface <span class="s2">&#34;</span><span class="si">${</span><span class="nv">t</span><span class="k">:-</span><span class="nv">$1</span><span class="si">}</span><span class="s2">&#34;</span>
<span class="k">fi</span>

<span class="c1"># ... 中略</span>
<span class="o">}</span>
</code></pre></div><p><code>cd::cd</code> では、それぞれに見合ったディレクトリのリストを作って、それを <code>cd::interface</code> に渡すだけである。</p>
<h2 id="cdlist"><code>cd::list</code></h2>
<p><code>cd::list</code> はディレクトリのリストを作成するだけの関数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cd::list<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -p /dev/stdin <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c1"># 標準入力がある場合それを読み込む</span>
        cat &lt;<span class="p">&amp;</span><span class="m">0</span>
    <span class="k">else</span>
        <span class="c1"># ない場合は、cd::cat_log を呼ぶ</span>
        cd::cat_log
    <span class="k">fi</span> <span class="p">|</span> reverse <span class="p">|</span> unique
    <span class="c1"># その内容を反転（reverse）させ重複した行を取り除く（unique）</span>
<span class="o">}</span>
</code></pre></div><p><code>cd::cat_log</code> はログファイルを <code>cat</code> するだけ。ただ、うまく噛みあうような処置を加えている。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cd::cat_log<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> -s <span class="s2">&#34;</span><span class="nv">$ENHANCD_LOG</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        cat <span class="s2">&#34;</span><span class="nv">$ENHANCD_LOG</span><span class="s2">&#34;</span>
    <span class="k">else</span>
        <span class="nb">echo</span>
    <span class="k">fi</span>
<span class="o">}</span>
</code></pre></div><p><code>reverse</code> して <code>unique</code> しているのはログの履歴の特性上のことである。例えば、このようなログがあるとする。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span><span class="nb">cd</span> /home/lisa/work/dir
<span class="gp">$ </span>cat <span class="nv">$ENHANCD_LOG</span>
<span class="go">/home/lisa/work
</span><span class="go">/home/lisa/work/dir
</span><span class="go">/home/lisa
</span><span class="go">/home/lisa/src/github.com/b4b4r07/enhancd
</span><span class="go">/home/lisa/work/dir
</span></code></pre></div><p><code>reverse</code> しないで <code>unique</code> するとこうなる（ちなみに <code>uniq</code> とは違ってソートせずに一意処理できるのが <code>unique</code> 関数である）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>cat <span class="nv">$ENHANCD_LOG</span> <span class="p">|</span> unique
<span class="go">/home/lisa/work
</span><span class="go">/home/lisa/work/dir
</span><span class="go">/home/lisa
</span><span class="go">/home/lisa/src/github.com/b4b4r07/enhancd
</span></code></pre></div><p>最新であるはずの <code>/home/lisa/work/dir</code> が上の方に重複している <code>/home/lisa/work/dir</code> に取り込まれてしまっている。これを防ぐために、一旦反転させてから行う。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-console" data-lang="console"><span class="gp">$ </span>cat <span class="nv">$ENHANCD_LOG</span> <span class="p">|</span> reverse <span class="p">|</span> unique
<span class="go">/home/lisa/work/dir
</span><span class="go">/home/lisa/src/github.com/b4b4r07/enhancd
</span><span class="go">/home/lisa
</span><span class="go">/home/lisa/work
</span></code></pre></div><p>しかしこのままでは、ログファイルが逆さま（上が最新）になっているので、もう一度最後に <code>reverse</code> する（ただ、enhancd では逆さまのままインタラクティブフィルタリングツールに渡している。というのもそれは、そっち側でうまく扱えるようにするためである）。</p>
<h2 id="cdnarrow"><code>cd::narrow</code></h2>
<p>これは絞り込みを行う関数である。<code>cd::interface</code> はインタラクティブ・フィルタリングツールを使っての絞り込みだがこれはその前段階である。<code>cd::cd</code> に与えられた引数で絞るだけである。存在しなかったら、ここでフィジーサーチにかける。これでもヒットしなかったら本当に存在しないか勘違いして覚えているか。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cd::narrow<span class="o">()</span>
<span class="o">{</span>
    <span class="nv">stdin</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span>cat &lt;<span class="p">&amp;</span>0<span class="k">)</span><span class="s2">&#34;</span>
    <span class="nv">m</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$stdin</span><span class="s2">&#34;</span> <span class="p">|</span> awk <span class="s1">&#39;/\/.?&#39;</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span><span class="s1">&#39;[^\/]*$/{print $0}&#39;</span> 2&gt;/dev/null<span class="k">)</span><span class="s2">&#34;</span>

    <span class="c1"># 引数が正しくなかったら、fuzzy-search をかける</span>
    <span class="k">if</span> empty <span class="s2">&#34;</span><span class="nv">$m</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$stdin</span><span class="s2">&#34;</span> <span class="p">|</span> cd::fuzzy <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>
    <span class="k">else</span>
        <span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$m</span><span class="s2">&#34;</span>
    <span class="k">fi</span>
<span class="o">}</span>
</code></pre></div><p><code>cd::fuzzy</code> の実装についてはレーベンシュタイン距離（編集距離）を算出し、それをもとに類似度を割り出している。今は 70% 以上の類似度となる文字列を候補としている。その実装のほとんどは awk によって処理している。これ以上の具体的な説明については省略する。</p>
<p>[https://raw.githubusercontent.com/b4b4r07/screenshots/master/enhancd/fuzzy.gif:image=https://raw.githubusercontent.com/b4b4r07/screenshots/master/enhancd/fuzzy.gif]</p>
<h2 id="cdinterface"><code>cd::interface</code></h2>
<p>ここでようやく <code>cd::interface</code> である。いわゆる enhancd cd のメイン処理をやっている関数で、引数としては改行で区切られたディレクトリのリストを期待する。それに対して、インタラクティブフィルタリングツール（peco や percol）によってフィルタするからだ。引数にあるリストがこの時点ですでに 1 つのとき、フィルタせずにそのまま移動する。2 つ以上のときフィルタを起動。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh">cd::interface<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">local</span> list
    <span class="nv">list</span><span class="o">=</span><span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span>

    <span class="c1"># cd::interface には引数（ディレクトリのリスト）が必要</span>
    <span class="k">if</span> empty <span class="s2">&#34;</span><span class="nv">$list</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
        die <span class="s2">&#34;cd::interface requires an argument at least&#34;</span>
        <span class="k">return</span> <span class="m">1</span>
    <span class="k">fi</span>

    <span class="c1"># リストの行数をカウントする</span>
    <span class="nb">local</span> wc
    <span class="nv">wc</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$list</span><span class="s2">&#34;</span> <span class="p">|</span> grep -c <span class="s2">&#34;&#34;</span><span class="k">)</span><span class="s2">&#34;</span>

    <span class="c1"># リストの行数によって振り分け</span>
    <span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$wc</span><span class="s2">&#34;</span> in
        <span class="m">0</span> <span class="o">)</span>
            <span class="c1"># Unbelievable branch</span>
            die <span class="s2">&#34;</span><span class="nv">$LINENO</span><span class="s2">: something is wrong&#34;</span>
            <span class="k">return</span> <span class="m">1</span>
            <span class="p">;;</span>
        <span class="m">1</span> <span class="o">)</span>
            <span class="c1"># 1 件ならフィルタは起動しない</span>
            <span class="k">if</span> <span class="o">[</span> -d <span class="s2">&#34;</span><span class="nv">$list</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                <span class="nb">builtin</span> <span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$list</span><span class="s2">&#34;</span>
            <span class="k">else</span>
                die <span class="s2">&#34;</span><span class="nv">$list</span><span class="s2">: no such file or directory&#34;</span>
                <span class="k">return</span> <span class="m">1</span>
            <span class="k">fi</span>
            <span class="p">;;</span>
        * <span class="o">)</span>
            <span class="c1"># それ以外はフィルタで絞る</span>
            <span class="nb">local</span> t
            <span class="nv">t</span><span class="o">=</span><span class="s2">&#34;</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&#34;</span><span class="nv">$list</span><span class="s2">&#34;</span> <span class="p">|</span> <span class="nb">eval</span> <span class="s2">&#34;</span><span class="nv">$filter</span><span class="s2">&#34;</span><span class="k">)</span><span class="s2">&#34;</span>
            <span class="k">if</span> ! empty <span class="s2">&#34;</span><span class="nv">$t</span><span class="s2">&#34;</span><span class="p">;</span> <span class="k">then</span>
                <span class="k">if</span> <span class="o">[</span> -d <span class="s2">&#34;</span><span class="nv">$t</span><span class="s2">&#34;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
                    <span class="nb">builtin</span> <span class="nb">cd</span> <span class="s2">&#34;</span><span class="nv">$t</span><span class="s2">&#34;</span>
                <span class="k">else</span>
                    die <span class="s2">&#34;</span><span class="nv">$t</span><span class="s2">: no such file or directory&#34;</span>
                    <span class="k">return</span> <span class="m">1</span>
                <span class="k">fi</span>
            <span class="k">fi</span>
            <span class="p">;;</span>
    <span class="k">esac</span>
<span class="o">}</span>
</code></pre></div><p>これによって最初の構想が実現できた。</p>
<h1 id="その他の機能">その他の機能</h1>
<p>enhancd には <code>cd -</code> と <code>cd ..</code> という機能がある。これはどちらも既存のものを尊重して拡張した機能になっている。</p>
<p><code>cd -</code> は「前にいたディレクトリ」に戻る機能である。最新 10 件のディレクトリヒストリだけを限定に絞込を行う。ここでも引数を取ることができるので、ここでも 1 件だけにマッチすればフィルタなしに移動でき、複数件にマッチすればそのままフィルタで絞り込む。</p>
<p><img src="https://raw.githubusercontent.com/b4b4r07/screenshots/master/enhancd/cd_hyphen.gif" alt=""></p>
<p><code>cd ..</code> はその通り、上のディレクトリに移動する。これは、すでにこれを拡張した bd（zsh-bd）というプラグインがあるが、それを模倣している。</p>
<p><img src="https://raw.githubusercontent.com/b4b4r07/screenshots/master/enhancd/bd.gif" alt=""></p>
<p>同じく、1 件にマッチすればそのまま移動、複数件にマッチすればフィルタ起動。親ディレクトリに重複した名前がある場合は ID をつけて区別する。</p>
<p>これらの実現に多数の関数が存在する。があくまでも本筋の機能ではないので省略。ただ、<code>cd::interface</code> にはディレクトリのリストを渡すというコンセプトは生きているので実装はとても簡単にできる。</p>
<p>新機能（新しいディレクトリリスト）を追加したいときは、候補のディレクトリリストを <code>cd::interface</code> に渡すだけ。といっても今のところこれ以上の機能を追加する予定はない。</p>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2022 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



