
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="GitHub のラベルを宣言的に管理する - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2018/11/19/github-label-management/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>GitHub のラベルを宣言的に管理する | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">GitHub のラベルを宣言的に管理する</h1>
    <h2 class="subtitle is-5">November 19, 2018 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/github">github</a>
    
        <a class="button is-link" href="/tags/golang">golang</a>
    
</div>

    
    <br>
    <div class="content">
      
      

<h2 id="ソフトウェアの宣言的設定について">ソフトウェアの宣言的設定について</h2>

<p>&ldquo;何かを管理する&rdquo;となったときに、宣言的に設定できるようになっていると非常に便利である。
この宣言的設定 (Infrastructure as Code) とは、イミュータブルなインフラ (Immutable Infrastructure) を作るための基本的な考え方で、システムの状態を設定ファイルにて宣言するという考え方である。
具体的には Kubernetes のマニフェストファイル (YAML) だったり、Terraform のコード (HCL) が挙げられる。
この考え方は、インフラ領域に限らず、何らかの状態管理にはもってこいの手法である。</p>

<p>GitHub のラベルは Issues/P-Rs を管理するために便利な機能である。
しかし、リポジトリの規模やラベルの数が増えてくると、ラベル自体も管理する必要が出てくる。
実際に Kubernetes 規模のリポジトリになると、ラベル管理なしにはやっていられない。
ラベルを管理するための <a href="https://github.com/kubernetes/test-infra/tree/master/prow">bot</a> やツールすら動いている。
実際に Kubernetes のコミュニティでは現在 180 個近くのラベルが定義されており、同様のラベルが導入されているリポジトリが数十個ある。</p>

<ul>
<li><a href="https://github.com/kubernetes/community/labels">Labels - kubernetes/community</a></li>
</ul>

<p>1つのリポジトリのラベルを管理するくらいならマニュアルでも可能だが、複数リポジトリとなるとリポジトリ間の同期が大変になってくる。
特に ZenHub などの GitHub Issues を使ったマネジメントをしている場合、ラベル名が一致されていることとその付随情報 (色や説明) の同期が必須になる。
人間が手で追加や変更をしていると、必ず差異が発生する。</p>

<p>ここで、冒頭に挙げた宣言的設定が有効な手段になる。</p>

<h2 id="github-labeler-の紹介">github-labeler の紹介</h2>

<p><a href="https://github.com/b4b4r07/github-labeler">https://github.com/b4b4r07/github-labeler</a></p>

<p>宣言的設定の手法をラベル管理に持ち込むために、GitHub ラベルの定義とそれを作るリポジトリについて「YAML に書いたとおりになる」ツールを書いた。</p>

<p>例えば次のような YAML を書く。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">labels<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>area/security<span class="w">
</span><span class="w">    </span>description<span class="p">:</span><span class="w"> </span>Indicates<span class="w"> </span>an<span class="w"> </span>issue<span class="w"> </span>on<span class="w"> </span>security<span class="w"> </span>area.<span class="w">
</span><span class="w">    </span>color<span class="p">:</span><span class="w"> </span>1d76db<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>kind/bug<span class="w">
</span><span class="w">    </span>description<span class="p">:</span><span class="w"> </span>Categorizes<span class="w"> </span>issue<span class="w"> </span>or<span class="w"> </span>PR<span class="w"> </span>as<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span>a<span class="w"> </span>bug.<span class="w">
</span><span class="w">    </span>color<span class="p">:</span><span class="w"> </span>d93f0b<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>kind/cleanup<span class="w">
</span><span class="w">    </span>description<span class="p">:</span><span class="w"> </span>Categorizes<span class="w"> </span>issue<span class="w"> </span>or<span class="w"> </span>PR<span class="w"> </span>as<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span>cleaning<span class="w"> </span>up<span class="w"> </span>code<span class="p">,</span><span class="w"> </span>process<span class="p">,</span><span class="w"> </span>or<span class="w"> </span>technical<span class="w"> </span>debt.<span class="w">
</span><span class="w">    </span>color<span class="p">:</span><span class="w"> </span>bfd4f2<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>kind/design<span class="w">
</span><span class="w">    </span>description<span class="p">:</span><span class="w"> </span>Categorizes<span class="w"> </span>issue<span class="w"> </span>or<span class="w"> </span>PR<span class="w"> </span>as<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span>design.<span class="w">
</span><span class="w">    </span>color<span class="p">:</span><span class="w"> </span>bfd4f2<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>kind/documentation<span class="w">
</span><span class="w">    </span>description<span class="p">:</span><span class="w"> </span>Categorizes<span class="w"> </span>issue<span class="w"> </span>or<span class="w"> </span>PR<span class="w"> </span>as<span class="w"> </span>related<span class="w"> </span>to<span class="w"> </span>documentation.<span class="w">
</span><span class="w">    </span>color<span class="p">:</span><span class="w"> </span>bfd4f2<span class="w">
</span><span class="w">
</span><span class="w"></span>repos<span class="p">:</span><span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>org/repo1<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>area/security<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/api-change<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/bug<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/cleanup<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/design<span class="w">
</span><span class="w">  </span>-<span class="w"> </span>name<span class="p">:</span><span class="w"> </span>org/repo2<span class="w">
</span><span class="w">    </span>labels<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/api-change<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/bug<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/cleanup<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>kind/design</code></pre></div>
<p>この YAML をもとに github-labeler を実行すると、こんな感じになる。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ github-labeler
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:40 create <span class="s2">&#34;area/security&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:40 create <span class="s2">&#34;kind/api-change&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:40 create <span class="s2">&#34;kind/bug&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:40 create <span class="s2">&#34;kind/cleanup&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:40 create <span class="s2">&#34;kind/design&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:41 create <span class="s2">&#34;kind/documentation&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;bug&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;deplicate&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;enhancement&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;good first issue&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;help wanted&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;invalid&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;question&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:30:42 delete <span class="s2">&#34;wontfix&#34;</span> in org/repo1</code></pre></div>
<p><img src="/images/github-label-management.png" alt="" /></p>

<p>定義されたラベル (<code>.labels</code>) が各リポジトリに存在しなければ作成し (<code>.repos[].labels</code>)、ここに羅列されていないラベルがある場合は削除するようになっている。
例えば、<code>org/repo2</code> にも <code>area/security</code> を追加したかったら、</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">  repos:
    - name: org/repo2
      labels:
<span class="gi">+       - area/security
</span><span class="gi"></span>        - kind/api-change
        - kind/bug
        - kind/cleanup
        - kind/design
</code></pre></div>
<p>として再実行すればいいし、逆に <code>kind/api-change</code> が要らなくなったら、</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">  repos:
    - name: org/repo2
      labels:
        - area/security
<span class="gd">-       - kind/api-change
</span><span class="gd"></span>        - kind/bug
        - kind/cleanup
        - kind/design
</code></pre></div>
<p>として再実行すればよい。
ラベルの色や説明を更新したい場合も同様である。</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">  labels:
    - name: area/security
      description: Indicates an issue on security area.
<span class="gd">-     color: 1d76db
</span><span class="gd"></span><span class="gi">+     color: 94cde8
</span></code></pre></div>
<p>既存のラベル名を変更する場合は、以下のように設定すれば良い。</p>

<p>(こうせずに作り直すと、GitHub 的にラベル名の変更のつながりがなくなるので、紐付いている previous label が剥がされてしまう)</p>
<div class="highlight"><pre class="chroma"><code class="language-diff" data-lang="diff">  labels:
<span class="gd">-   - name: area/security
</span><span class="gd"></span><span class="gi">+   - name: area/new-name
</span><span class="gi"></span>      description: Indicates an issue on security area.
      color: 1d76db
<span class="gi">+     previous_name: area/security
</span></code></pre></div>
<p>実行を終えてラベル名が <code>area/new-name</code> に変更されたら <code>previous_name:</code> は不要になるので、2回目以降の実行のときには消しても問題ない。</p>

<h2 id="ci-と組み合わせる">CI と組み合わせる</h2>

<p>宣言的設定のいいところの一つに設定をレビューしあうことができる点がある。
github-labeler には dry run の機能があるので、P-R が出されたときにレビューしつつ実行計画を見ることができる。</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">version<span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w"></span>jobs<span class="p">:</span><span class="w">
</span><span class="w">  </span>plan<span class="p">:</span><span class="w">
</span><span class="w">    </span>steps<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>checkout<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>run<span class="p">:</span><span class="w">
</span><span class="w">          </span>name<span class="p">:</span><span class="w"> </span>Run<span class="w"> </span>github-labeler<span class="w"> </span>(dry-run)<span class="w">
</span><span class="w">          </span>command<span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">            github-labeler -manifest labels_config.yaml -dry-run</span><span class="w">
</span><span class="w">  </span>apply<span class="p">:</span><span class="w">
</span><span class="w">    </span>steps<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>checkout<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>run<span class="p">:</span><span class="w">
</span><span class="w">          </span>name<span class="p">:</span><span class="w"> </span>Run<span class="w"> </span>github-labeler<span class="w">
</span><span class="w">          </span>command<span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">            github-labeler -manifest labels_config.yaml</span><span class="w">
</span><span class="w">
</span><span class="w"></span>workflows<span class="p">:</span><span class="w">
</span><span class="w">  </span>version<span class="p">:</span><span class="w"> </span><span class="m">2</span><span class="w">
</span><span class="w">  </span>github-labeler<span class="p">:</span><span class="w">
</span><span class="w">    </span>jobs<span class="p">:</span><span class="w">
</span><span class="w">      </span>-<span class="w"> </span>plan<span class="p">:</span><span class="w">
</span><span class="w">          </span>filters<span class="p">:</span><span class="w">
</span><span class="w">            </span>branches<span class="p">:</span><span class="w">
</span><span class="w">              </span>ignore<span class="p">:</span><span class="w"> </span>master<span class="w">
</span><span class="w">      </span>-<span class="w"> </span>apply<span class="p">:</span><span class="w">
</span><span class="w">          </span>filters<span class="p">:</span><span class="w">
</span><span class="w">            </span>branches<span class="p">:</span><span class="w">
</span><span class="w">              </span>only<span class="p">:</span><span class="w"> </span>master</code></pre></div>
<p>上のような CI 設定 (Circle CI) を書くことで、より Infra as Code をプラクティスを持ち込むことができる。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ github-labeler -manifest labels_config.yaml -dry-run
<span class="m">2018</span>/11/19 <span class="m">18</span>:45:42 create <span class="s2">&#34;lifecycle/stale&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:45:42 create <span class="s2">&#34;lifecycle/rotten&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:45:43 edit <span class="s2">&#34;kind/api-change&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:45:43 edit <span class="s2">&#34;kind/bug&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:45:44 edit <span class="s2">&#34;kind/cleanup&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:45:44 edit <span class="s2">&#34;kind/design&#34;</span> in org/repo1
<span class="m">2018</span>/11/19 <span class="m">18</span>:45:51 delete <span class="s2">&#34;kind/documentation&#34;</span> in org/repo1</code></pre></div>
<h2 id="まとめ">まとめ</h2>

<p>宣言的設定をソフトウェア以外にも応用すると、レビューができるようになったり設定の状態をコードでみることができるので、とても便利になる。
これで、複数リポジトリを横断しても比較的簡単に GitHub のラベルを統一的に管理することができるようなった。</p>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
    
      <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2020 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



