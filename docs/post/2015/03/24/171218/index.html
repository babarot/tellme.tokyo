
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="書くのが面倒な zsh 補完関数を簡単に生成するツール「zgencomp」つくった - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2015/03/24/171218/">
<meta property="og:description" content="Masaki ISHIYAMA">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>書くのが面倒な zsh 補完関数を簡単に生成するツール「zgencomp」つくった | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/highlight-solarized-light.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">書くのが面倒な zsh 補完関数を簡単に生成するツール「zgencomp」つくった</h1>
    <h2 class="subtitle is-5">March 24, 2015 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/go">go</a>
    
        <a class="button is-link" href="/tags/zsh">zsh</a>
    
</div>

    
    <br>
    <div class="content">
      
        <a href="https://b4b4r07.hatenadiary.com/entry/2015/03/24/171218">元記事</a><br><br>
      
      

<p><a href="https://github.com/b4b4r07/zgencomp">b4b4r07/zgencomp・GitHub</a></p>

<p><code>zgencomp</code> を使えば、Zsh コマンドの補完関数を簡単に生成することができます。</p>

<h2 id="背景">背景</h2>

<p>Zsh の醍醐味のひとつが補完機能であるのは言わずもがなですね。</p>

<p>この補完について、基本的なコマンドや有名プロジェクトのコマンドなどの多くは提供されているのですが、自作コマンドもちろんのこと、マイナーなコマンドは提供されていなかったりします。</p>

<p>その場合、ユーザが Zsh スクリプトの記法で補完ファイルを記述しなければなりません。これが結構骨の折れる作業で、Zsh が提供する補完インターフェースは高機能ゆえに複雑怪奇で、並みのユーザはおろか熟練のシェルスクリプターでも投げ出したくなる様です。</p>

<p>特に自作コマンドの場合、コマンドの作成で疲弊して、マニュアルやドキュメンテーションでも疲弊しているところにこの補完機能の作業となると、まず補完は諦めがちです。</p>

<h2 id="zgencomp-を使う">zgencomp を使う</h2>

<p>そこでこのツールです。</p>

<p>まずはデモを。</p>

<p><a href="https://github.com/b4b4r07/zgencomp" title="b4b4r07/zgencomp・GitHub"><img src="https://raw.githubusercontent.com/b4b4r07/zgencomp/master/data/zgencomp.gif" alt="zgencomp" /></a></p>

<p>JSON ファイルに設定を記述し、それをもとに補完関数を生成します。JSON ファイルはある程度のテンプレートが用意されているので書き換える形で簡単に設定できます。</p>

<h2 id="json-ファイルの書き方">JSON ファイルの書き方</h2>

<h3 id="command">&ldquo;command&rdquo;</h3>

<p>サンプルである <a href="https://raw.githubusercontent.com/b4b4r07/zgencomp/master/data/templates/sample.json">JSON ファイル</a>の書き換え方について紹介します。</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
    <span class="nt">&#34;command&#34;</span> <span class="p">:</span> <span class="s2">&#34;mycmd&#34;</span><span class="p">,</span>

    <span class="nt">&#34;properties&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;author&#34;</span> <span class="p">:</span> <span class="s2">&#34;John Doe&#34;</span><span class="p">,</span>
        <span class="nt">&#34;license&#34;</span> <span class="p">:</span> <span class="s2">&#34;MIT&#34;</span><span class="p">,</span></code></pre></div>
<p>ここらへんはそのままですね。ただし、<code>&quot;command&quot;</code> が空白の場合、パースエラーになります。</p>

<h3 id="properties">&ldquo;properties&rdquo;</h3>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">        <span class="s2">&#34;help&#34;</span> <span class="err">:</span> <span class="p">{</span>
            <span class="nt">&#34;option&#34;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="s2">&#34;-h&#34;</span><span class="p">,</span>
                <span class="s2">&#34;--help&#34;</span>
            <span class="p">],</span>
            <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;show this help and exit&#34;</span>
        <span class="p">}</span><span class="err">,</span></code></pre></div>
<p>ヘルプやバージョンに関するオプションについては通常のオプションとしては扱わず、コマンドの属性情報（<code>&quot;properties&quot;</code>）として処理します。</p>

<p>また、<code>&quot;option&quot;</code> について指定できるオプションは <code>-</code> または <code>--</code> から始まる文字列です（ショート／ロング オプション）。加えて、1つ以上のオプション指定が必須です。1つも指定されていない場合は、補完が実行されません。
これは <code>&quot;help&quot;</code> の <code>&quot;option&quot;</code> だけではなくすべての <code>&quot;option&quot;</code> に当てはまります。</p>

<p><code>&quot;description&quot;</code> は補完されるときに説明として表示されるものです。空欄でもパースエラーにはなりませんが、他にも空欄のコマンドがあるとうまく補完されないので注意です。</p>

<h3 id="options">&ldquo;options&rdquo;</h3>

<p><code>&quot;options&quot;</code> は <code>&quot;switch&quot;</code> と <code>&quot;flag&quot;</code> から成ります。前者は引数を取らず、後者はオプション引数を要求します。
（<code>&quot;options&quot;</code> と <code>&quot;option&quot;</code> は似ているので注意が必要です。前者はフラグをスイッチの総称で、後者は実際のオプション文字列自体を指します）</p>

<h4 id="switch">&ldquo;switch&rdquo;</h4>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">    <span class="s2">&#34;options&#34;</span> <span class="err">:</span> <span class="p">{</span>
        <span class="nt">&#34;switch&#34;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&#34;option&#34;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&#34;-i&#34;</span><span class="p">,</span>
                    <span class="s2">&#34;--interactive&#34;</span>
                <span class="p">],</span>
                <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;show with plain text&#34;</span><span class="p">,</span>
                <span class="nt">&#34;exclusion&#34;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&#34;-f&#34;</span><span class="p">,</span>
                    <span class="s2">&#34;--force&#34;</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">],</span></code></pre></div>
<p><code>&quot;option&quot;</code> や <code>&quot;description&quot;</code> はヘルプなどのそれとほぼ変わりません。</p>

<p><code>&quot;exclusion&quot;</code> とはオプションの排他制御です。一般的に、コマンドのオプションには同時に指定しても無意味な組み合わせがあります。例えば、<code>ssh</code> の <code>-4</code>、<code>-6</code> オプションはそれぞれ <code>IPv4</code>、<code>IPv6</code> で明示的に接続するためのものですが、両方指定するのは無意味です。そのときに、補完候補から取り除いてくれる設定がこの <code>&quot;exclusion&quot;</code> です。</p>

<h4 id="flag">&ldquo;flag&rdquo;</h4>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">        <span class="s2">&#34;flag&#34;</span> <span class="err">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&#34;option&#34;</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="s2">&#34;-A&#34;</span><span class="p">,</span>
                    <span class="s2">&#34;--after-context&#34;</span>
                <span class="p">],</span>
                <span class="nt">&#34;description&#34;</span> <span class="p">:</span> <span class="s2">&#34;Print num lines of trailing context after each match&#34;</span><span class="p">,</span>
                <span class="nt">&#34;exclusion&#34;</span> <span class="p">:</span> <span class="p">[</span>
                <span class="p">],</span>
                <span class="nt">&#34;argument&#34;</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&#34;group&#34;</span> <span class="p">:</span> <span class="s2">&#34;&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;files&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;style&#34;</span> <span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&#34;standard&#34;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&#34;-A&#34;</span><span class="p">],</span>
                            <span class="nt">&#34;touch&#34;</span> <span class="p">:</span> <span class="p">[],</span>
                            <span class="nt">&#34;touchable&#34;</span> <span class="p">:</span> <span class="p">[],</span>
                            <span class="nt">&#34;equal&#34;</span> <span class="p">:</span> <span class="p">[</span><span class="s2">&#34;--after-context&#34;</span><span class="p">],</span>
                            <span class="nt">&#34;equalable&#34;</span> <span class="p">:</span> <span class="p">[]</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">},</span></code></pre></div>
<p>これは引数を取るオプションです。先程よりも少し複雑化します。</p>

<p><code>&quot;option&quot;</code>、<code>&quot;description&quot;</code>、<code>&quot;exclusion&quot;</code> までは同じです。<code>&quot;argument&quot;</code> は このフラグオプションが引数として取る文字列についての詳細な設定項目です。</p>

<ul>
<li><p><code>&quot;group&quot;</code> は補完のさいにグルーピングされる時の文字列です。</p>

<p>[f:id:b4b4r07:20150324171210p:plain]</p></li>

<li><p><code>&quot;type&quot;</code> は実際に補完されるワードについてです。</p>

<p>&ldquo;file&rdquo; を指定した場合、ファイルについて補完されます。
&ldquo;dir&rdquo;、&rdquo;directory&rdquo; はディレクトリ補完です。
&ldquo;func&rdquo; はカスタムタイプです。複雑な条件のもと補完ワードを選出する場合に利用します。別途、補完ワードを返す関数などを記述する必要があります。
補完ワードが決まりきっている場合（例：&rdquo;foo&rdquo; と &ldquo;bar&rdquo; だけ、など）は補完ワードをベタ書き可能です。そのときは array タイプで記述します。</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="s2">&#34;type&#34;</span> <span class="err">:</span> <span class="p">[</span>
    <span class="s2">&#34;init&#34;</span><span class="p">,</span>
    <span class="s2">&#34;add&#34;</span><span class="p">,</span>
    <span class="s2">&#34;commit&#34;</span>
<span class="p">]</span><span class="err">,</span></code></pre></div>
<p>また、補完ワードに説明を付与したい場合は以下のように記述できます。</p>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="s2">&#34;type&#34;</span> <span class="err">:</span> <span class="p">{</span>
    <span class="nt">&#34;init&#34;</span> <span class="p">:</span> <span class="s2">&#34;Create an empty Git repository or reinitialize an existing one&#34;</span><span class="p">,</span>
    <span class="nt">&#34;add&#34;</span> <span class="p">:</span> <span class="s2">&#34;Add file contents to the index&#34;</span><span class="p">,</span>
    <span class="nt">&#34;commit&#34;</span> <span class="p">:</span> <span class="s2">&#34;Record changes to the repository&#34;</span>
<span class="p">}</span></code></pre></div>
<p>結果：
[f:id:b4b4r07:20150324171135p:plain]</p></li>

<li><p>最後に <code>&quot;style&quot;</code> についてです。</p>

<p>これはオプションの引数の取り方（スタイル）を定義します。<code>--output=a.txt</code> というようなオプション指定にあるイコールなどです。</p>

<table>
<thead>
<tr>
<th align="center">スタイル名</th>
<th align="left">スタイルの様子</th>
</tr>
</thead>

<tbody>
<tr>
<td align="center"><strong>standard</strong></td>
<td align="left"><code>-opt VAL</code></td>
</tr>

<tr>
<td align="center"><strong>touch</strong></td>
<td align="left"><code>-optVAL</code></td>
</tr>

<tr>
<td align="center"><strong>touchable</strong></td>
<td align="left"><code>-optVAL</code> or <code>-opt VAL</code></td>
</tr>

<tr>
<td align="center"><strong>equal</strong></td>
<td align="left"><code>opt=VAL</code></td>
</tr>

<tr>
<td align="center"><strong>equalable</strong></td>
<td align="left"><code>-opt=VAL</code> or <code>-opt VAL</code></td>
</tr>
</tbody>
</table>

<p>オプションはいずれかのスタイルに所属します。何も指定されないオプションは &ldquo;standard&rdquo; として扱われます。また、一つのオプションが複数のスタイルに所属する場合、最初に指定したスタイルが適応されます。</p></li>
</ul>

<h3 id="arguments">&ldquo;arguments&rdquo;</h3>
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json">    <span class="s2">&#34;arguments&#34;</span> <span class="err">:</span> <span class="p">{</span>
        <span class="nt">&#34;always&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nt">&#34;type&#34;</span> <span class="p">:</span> <span class="s2">&#34;func&#34;</span>
    <span class="p">}</span>
<span class="err">}</span></code></pre></div>
<h2 id="使い方">使い方</h2>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ zgencomp -g</code></pre></div>
<p>サンプルの JSON ファイルを生成します。</p>

<p>そして、[JSON ファイルの書き方]()を参考にして自分のコマンドのUIに合うように書き換えてください。</p>

<p>そして、</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ zgencomp</code></pre></div>
<p>で補完関数が標準出力に出されます。<code>zgencomp some.json</code> にように引数を取って指名しても構いません。上のように省略された場合はカレントディレクトリにある <code>sample.json</code>（<code>zgencomp -g</code> に呼応）を読みに行きます。</p>

<h2 id="インストール">インストール</h2>

<p>Go 言語の環境を要求します。近いうち、というかバージョン1.0にしたときに Releases にバイナリをアップロードする予定です。</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ go get github.com/b4b4r07/zgencomp
$ <span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/github.com/b4b4r07/zgencomp
$ make install</code></pre></div>
<h2 id="最後に">最後に</h2>

<p>結構便利にサクッと補完関数が生成されます。使ってみてください。</p>

<h3 id="備考">備考</h3>

<p>まだまだアルファ版です（バージョン0.2）。非互換なバージョンアップは避けるつもりですが、急に JSON のフォーマットなどが変更される場合があります。</p>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
    
      <a href="http://b.hatena.ne.jp/entry/https://b4b4r07.hatenadiary.com/entry/2015/03/24/171218" class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://b4b4r07.github.io"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2020 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



