
<!DOCTYPE html>
<html lang="ja-jp">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="b4b4r07, babarot" name="keywords">
<meta content="b4b4r07" name="author">
<meta property="og:title" content="Kubernetes 開発環境構築のいろは - tellme.tokyo">
<meta property="og:url" content="https://tellme.tokyo/post/2017/12/01/kubeabc/">
<meta property="og:description" content="tellme.tokyo">
<meta property="og:type" content="website" />

<meta property="og:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">
<meta name="twitter:image" content="https://raw.githubusercontent.com/b4b4r07/tellme.tokyo/master/static/images/profile.jpg">

<title>Kubernetes 開発環境構築のいろは | tellme.tokyo</title>
<link rel="stylesheet" href="https://tellme.tokyo/css/style.css">
<link rel="stylesheet" href="https://tellme.tokyo/css/custom.css">
<link rel="shortcut icon" href="https://tellme.tokyo/favicon.ico">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/github.min.css">


<section class="section">
  <div class="container">
    <nav class="nav">
      <div class="nav-left">
        <a class="nav-item" href="https://tellme.tokyo"><h1 class="title is-4">tellme.tokyo</h1></a>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
          <a class="level-item" href="https://github.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-github"></i>
            </span>
          </a>
          
          <a class="level-item" href="https://twitter.com/b4b4r07" target="_blank">
            <span class="icon">
              <i class="fa fa-twitter"></i>
            </span>
          </a>
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">Kubernetes 開発環境構築のいろは</h1>
    <h2 class="subtitle is-5">December 1, 2017 </h2>
    
      <div class="tags">
    
        <a class="button is-link" href="/tags/kubernetes">kubernetes</a>
    
</div>

    
    <br>
    <div class="content">
      
      

<h2 id="はじめに">はじめに</h2>

<p><a href="https://qiita.com/advent-calendar/2017/kubernetes2">Kubernetes2 Advent Calendar 2017 - Qiita</a> 1 日目です。</p>

<p>Kubernetes 上で動かすアプリを作ることが多くなってきていると思いますが、従来のオペレーションとは違う方法で開発やデプロイなどを行う必要があります。
Kubernetes の実行環境として GKE を例に取ると、GCP プロジェクトやその中で作った GKE クラスタ、Kubernetes ネームスペースなど、見る必要のある領域が増えるとともに今までのやり方も変わるはずです。
本記事ではその際のユースケースと、それをいい感じにしてくれるツールを紹介します。</p>

<h2 id="今いるクラスタは何か">今いるクラスタは何か</h2>

<p>本番環境と開発環境 (Prod / Dev) でクラスタを分けることは多いと思います。
その他にもクラスタを持っていることもあるでしょう。</p>

<p><a href="http://tech.mercari.com/entry/2017/08/21/092743">Continuous Delivery のプラットフォーム</a>として <a href="https://www.spinnaker.io/">Spinnaker</a> が注目されつつあるので、Kubernetes クラスタへのデプロイはこれに置き換わる可能性<sup class="footnote-ref" id="fnref:1"><a href="#fn:1">1</a></sup>はありますが、Spinnaker がサポートしていない Kubernetes リソース (例えば、<a href="https://kubernetes.io/docs/concepts/workloads/pods/disruptions/">PodDisruptionBudget</a> など) については、まだ手動で <code>kubectl apply</code> せざるを得ません。
また、基本的なリソースに対する apply 相当のことが Spinnaker によってできるようになったとはいえ、まだまだ手動で apply を実行したい場面もあります。
そこで気をつけたいのは、今いるクラスタとネームスペースの確認です。</p>

<p>Spinnaker は「デプロイ先のクラスタ」と「どのイメージを撒くか (manifest file)」をセットにして内部に持っているので「意図しないクラスタに対して意図しない manifest file をデプロイしてしまう」といった誤操作は防げるのですが、これが <code>kubectl apply</code> による手動だと今いるクラスタと <code>-f</code> に渡すファイル次第で、互い違いにデプロイしてしまうなどの事故も起こしかねません<sup class="footnote-ref" id="fnref:2"><a href="#fn:2">2</a></sup>。
毎回指差し確認するのも面倒ですし、そもそも確認を徹底するというのは有効打ではないので、常に見えるところに表示しておくのがおすすめです。</p>

<iframe
  class="hatenablogcard"
  style="width:100%;height:155px;max-width:420px;"
  src="https://hatenablog-parts.com/embed?url=https%3a%2f%2fgithub.com%2fb4b4r07%2fkubeabc"
  title=""
  width="300"
  height="150"
  frameborder="0"
  scrolling="no">
</iframe>


<p>手前味噌ですが、現在の Kubernetes クラスタと GCP プロジェクトを表示できるコマンドを書きました。</p>

<pre><code class="language-console">$ ./kubeabc/cli/kube-context/kube-context
gke_tellme-tokyo/default
</code></pre>

<p><code>クラスタ名/ネームスペース名</code> になっています。今は長さの関係でリージョン以降は丸めています。</p>

<p>GCP プロジェクトも同じように表示できます。</p>

<pre><code class="language-console">$ ./kubeabc/cli/gcp-context/gcp-context
gcalcli-1327
</code></pre>

<p>普段は tmux を使っているので、ステータスバーに表示してあります。</p>

<pre><code>set-option -g status-left 'tmux:[#P] #[fg=colour33](K) #(~/bin/kube-context)#[default] #[fg=colour1](G) #(~/bin/gcp-context 2&gt;&amp;1)#[default]'
</code></pre>


<figure >
  
    <img
    src="/images/kubeabc/tmux-bar.png"
    
    width="400"
    />
    
  
</figure>



<p>シェルのプロンプトに表示できるプラグインも公開されています。</p>

<ul>
<li><a href="https://github.com/superbrothers/zsh-kubectl-prompt">https://github.com/superbrothers/zsh-kubectl-prompt</a></li>
<li><a href="https://github.com/ocadaruma/zsh-gcloud-prompt">https://github.com/ocadaruma/zsh-gcloud-prompt</a></li>
</ul>

<p>とはいえ、常に見えるところに表示しておく、というのもあまり効果的でもないので、apply するときに ask してくるようにしました (後述)。</p>

<h2 id="クラスタ切り替え">クラスタ切り替え</h2>

<p>Dev / Prod のスイッチなど一日に何回もします。
そのたびに <code>gcloud container clusters get-credentials ~</code> といった長いコマンドは打っていられません。</p>

<p><a href="https://github.com/ahmetb/kubectx/blob/master/kubectx">kubectx</a> というコンテキストの切り替えに特化した便利ツールがあるので、これを利用すると良いです。</p>

<p>個人的には <a href="https://github.com/junegunn/fzf">fzf</a>/<a href="https://github.com/peco/peco">peco</a> を噛ませたラッパーを使うようにしました: <a href="https://github.com/b4b4r07/kubeabc/blob/master/cli/kubectx">https://github.com/b4b4r07/kubeabc/blob/master/cli/kubectx</a></p>

<h2 id="ネームスペース切り替え">ネームスペース切り替え</h2>

<p>クラスタよりも切り替えることの多いのがネームスペースです。
ネームスペースはサービスごとに切ることが多いと思います。
複数のサービスを見ていると <code>kubectl get -n ネームスペース ...</code> とネームスペースを指定して実行するのが面倒になってくるので、先にデフォルトのネームスペースを切り替えておくとよいです。
ちなみに指定しない場合はデフォルトで <code>default</code> のネームスペースが使用されます。</p>

<p>これも、kubectx と同じく <a href="https://github.com/ahmetb/kubectx/blob/master/kubens">kubens</a> というネームスペースの切り替えに特化した便利ツールがあるので、これを利用すると良いです。</p>

<p>また、これも <a href="https://github.com/junegunn/fzf">fzf</a>/<a href="https://github.com/peco/peco">peco</a> を噛ませたラッパーを使うようにしました: <a href="https://github.com/b4b4r07/kubeabc/blob/master/cli/kubens">https://github.com/b4b4r07/kubeabc/blob/master/cli/kubens</a></p>


<figure >
  
    <img
    src="/images/kubeabc/kubens.gif"
    
    width="600"
    />
    
  
</figure>



<h2 id="ログを見やすくする">ログを見やすくする</h2>

<p><code>kubectl logs</code> でログは見れますが、Pod 単位ではなく、Service 単位であったり Namespace 単位で見たい場合が多いでしょう。
そんなときは以下のツールを試すと良いです。</p>

<ul>
<li><a href="https://github.com/wercker/stern">https://github.com/wercker/stern</a></li>
<li><a href="https://github.com/johanhaleby/kubetail">https://github.com/johanhaleby/kubetail</a></li>
<li><a href="https://github.com/boz/kail">https://github.com/boz/kail</a></li>

<li><p><a href="https://github.com/dtan4/k8stail">https://github.com/dtan4/k8stail</a></p>

<pre><code class="language-console">$ stern wiki
</code></pre></li>
</ul>

<p>こんな感じに、ゆるく指定することができるので wiki に関する Pod のログをまとめてみることができます。</p>


<figure >
  
    <img
    src="/images/kubeabc/stern.gif"
    
    width="600"
    />
    
  
</figure>



<p>詳しくは: <a href="https://medium.com/@lestrrat/kubernetes使いは全員-stern-を導入すべき-bc9d3eb2c321/">kubernetes使いは全員 stern を導入すべき – Daisuke Maki – Medium</a></p>

<h2 id="pod-などのリソースに手早くアクセス">Pod などのリソースに手早くアクセス</h2>

<p><code>kubectl exec -it xxx-service-dev-v185-qjkh6 bash</code> とか長くて打てません。
<code>kubectl get pods</code> して Pod 名をコピペすることになると思いますが、頻繁にやっているとシンドイです。
こんなときは、Global alias を使うと便利です (zsh ユーザに限られます)。</p>

<pre><code class="language-console">$ kubectl exec -it P bash
</code></pre>

<p>キャピタルの <code>P</code> は <code>kubectl get pods | fzf</code> に展開して実行されるので、インタラクティブに Pod を選んで exec に渡すことができます。</p>

<pre><code class="language-console">$ kubectl get P
$ kubectl logs -f P
</code></pre>


<figure >
  
    <img
    src="/images/kubeabc/global_alias.gif"
    
    width="600"
    />
    
  
</figure>



<p>Pod 以外にもいろいろなリソースに対して Gloabl alias を設定しておくことで、短縮して実行することができるようになります。</p>

<p>詳しくは次のリンクを見てください。</p>

<p><a href="https://github.com/b4b4r07/kubeabc/blob/master/scripts/alias.zsh">https://github.com/b4b4r07/kubeabc/blob/master/scripts/alias.zsh</a></p>

<p><code>kubectl</code> に関する alias についての Tips がまとまっていたのですが、個人的にこのたぐいは覚えられないので Global alias だけを使っています。</p>

<ul>
<li><a href="https://ahmet.im/blog/kubectl-aliases/">Fun with kubectl aliases</a></li>
<li><a href="https://github.com/ahmetb/kubectl-aliases">https://github.com/ahmetb/kubectl-aliases</a></li>
</ul>

<h2 id="対話的にコマンド打ち込む">対話的にコマンド打ち込む</h2>

<p>本番環境などに対して <code>kubectl</code> コマンドを大量に打ち込むことはないですが、例えば自分が立てた Kubernetes クラスタなどに対して、試験的に動作確認したりする際に便利でした。</p>

<ul>
<li><a href="https://github.com/c-bata/kube-prompt">https://github.com/c-bata/kube-prompt</a></li>
<li><a href="https://github.com/cloudnativelabs/kube-shell">https://github.com/cloudnativelabs/kube-shell</a></li>
<li><a href="https://github.com/errordeveloper/kubeplay">https://github.com/errordeveloper/kubeplay</a></li>
</ul>

<h2 id="kube-系のコマンドをまとめる">kube 系のコマンドをまとめる</h2>

<iframe
  class="hatenablogcard"
  style="width:100%;height:155px;max-width:420px;"
  src="https://hatenablog-parts.com/embed?url=https%3a%2f%2fgithub.com%2fb4b4r07%2fkubeabc%2fblob%2fmaster%2fcli%2fkube"
  title=""
  width="300"
  height="150"
  frameborder="0"
  scrolling="no">
</iframe>


<p><a href="https://github.com/b4b4r07/kubeabc/blob/master/cli/kube">https://github.com/b4b4r07/kubeabc/blob/master/cli/kube</a></p>

<p><a href="https://github.com/ahmetb/kubectx">kubectx</a> などもそうですが、<code>kube*</code>、<code>kube-*</code> 系の Third party コマンドやエイリアスができてくると、kubectl 系のコマンドと統一したくなります (git のサブコマンドと同じメカニズムで)。</p>

<p>例えば <a href="https://github.com/saracen/kubeql">kubeql</a>、<a href="https://github.com/cloudnativelabs/kube-shell">kube-shell</a> といったコマンドの名前の差異をいい感じに吸収して、<code>kubectl</code> のサブコマンドの一つとしてまとめて実行できるので便利です。
内部はほとんど <code>kubectl</code> のラッパーとして書いています。</p>


<figure >
  
    <img
    src="/images/kubeabc/kube_shell.png"
    
    width="600"
    />
    
  
</figure>



<p>また、これも git と同じように、サブコマンドやリソースのタイポを直して実行してくれるようになっています (地味に便利)。</p>


<figure >
  
    <img
    src="/images/kubeabc/kube_typo.png"
    
    width="600"
    />
    
  
</figure>



<p>前述したように、クラスタを表示しておくというのも確認の延長線にすぎないので、apply などの前に「このクラスタに実行しますよ」という旨を表示します。</p>


<figure >
  
    <img
    src="/images/kubeabc/kube_apply.png"
    
    width="600"
    />
    
  
</figure>



<h2 id="まとめ">まとめ</h2>

<p>個人的に便利なツールを紹介しました。
<a href="https://aws.amazon.com/eks/">EKS</a> も発表されたことですし、ガンガン Kubernetes を利用していきましょう。</p>
<div class="footnotes">

<hr />

<ol>
<li id="fn:1">Prod クラスタに Dev クラスタ用の manifest file を撒いてしまうとか
 <a class="footnote-return" href="#fnref:1"><sup>[return]</sup></a></li>
<li id="fn:2">現時点でも置き換えつつあるところも増えていると思います
 <a class="footnote-return" href="#fnref:2"><sup>[return]</sup></a></li>
</ol>
</div>

    </div>
    <br>
    <div class="social">
  
  
    
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="b4b4r07" data-count="horizontal" lang="en">Tweet</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  
    
      <a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="simple-balloon" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>
    
  
  
  
</div>

  </div>
</section>


<section class="section">
  <div class="container has-text-centered header-logo">
    <a href="https://tellme.tokyo"><img src="/images/profile.jpg" width="64" height="64"></a><br><br>
    <p>Copyright &copy; 2019 BABAROT All Right Reserved.</p>
  </div>
</section>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" integrity="sha256-KbfTjB0WZ8vvXngdpJGY3Yp3xKk+tttbqClO11anCIU=" crossorigin="anonymous"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/go.min.js"></script>

<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/languages/dockerfile.min.js"></script>

<script>hljs.initHighlightingOnLoad();</script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-44183504-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



